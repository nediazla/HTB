# Enumeración acreditada: desde Windows

---

En la sección anterior, exploramos algunas herramientas que podemos usar de nuestro host de ataque de Linux para enumeración con credenciales de dominio válidas. En esta sección, experimentaremos con algunas herramientas para enumerar desde un host de ataque de Windows, como Sharphound/BloodHound, PowerView/Sharpview, Grouper2, Snaffler y algunas herramientas incorporadas útiles para la enumeración de la ADA. Algunos de los datos que recopilamos en esta fase pueden proporcionar más información para los informes, no solo conducen directamente a rutas de ataque. Dependiendo del tipo de evaluación, nuestro cliente puede estar interesado en todos los hallazgos posibles, por lo que incluso problemas como la capacidad de ejecutar el sabueso libremente o ciertos atributos de la cuenta de usuario pueden valer la pena incluir en nuestro informe como hallazgos de riesgo medio o una sección de apéndice separada. No todos los problemas que descubrimos deben estar orientados a reenviar nuestros ataques. Algunos de los resultados pueden ser de naturaleza informativa pero útil para el cliente para ayudar a mejorar su postura de seguridad.

En este punto, estamos interesados ​​en otras configuraciones erróneas y problemas de permiso que podrían conducir a un movimiento lateral y vertical. También estamos interesados ​​en obtener una imagen más amplia de cómo se establece el dominio, es decir, ¿existen algún fideicomiso con otros dominios dentro y fuera del bosque actual? También estamos interesados ​​en las acciones de los archivos de saqueo que nuestro usuario tiene acceso, ya que a menudo contienen datos confidenciales, como credenciales que pueden usarse para promover nuestro acceso.

---

## TTPS

La primera herramienta que exploraremos es la[Módulo activectory powershell](https://docs.microsoft.com/en-us/powershell/module/activedirectory/?view=windowsserver2022-ps). Al aterrizar en un host de Windows en el dominio, especialmente uno que usa un administrador, existe la posibilidad de que encuentre herramientas y scripts valiosos en el host.

---

## Módulo activectory powershell

El módulo de PowerShell de ActiveDirectory es un grupo de cmdlets de PowerShell para administrar un entorno de activo de directorio desde la línea de comando. Consiste en 147 cmdlets diferentes al momento de escribir. No podemos cubrirlos a todos aquí, pero veremos algunos que son particularmente útiles para enumerar los entornos publicitarios. Siéntase libre de explorar otros cmdlets incluidos en el módulo en el laboratorio construido para esta sección, y vea qué interesantes combinaciones y salida puede crear.

Antes de que podamos utilizar el módulo, debemos asegurarnos de que se importe primero. El[Get-Module](https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/get-module?view=powershell-7.2)cmdlet, que es parte del[Microsoft.Powershell.core módulo](https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/?view=powershell-7.2), enumerará todos los módulos disponibles, su versión y los posibles comandos para su uso. Esta es una excelente manera de ver si se instalan algo como GIT o Scripts Administrator personalizados. Si el módulo no está cargado, ejecute`Import-Module ActiveDirectory`Para cargarlo para su uso.

#### Descubrir módulos

  Enumeración acreditada: desde Windows

```powershell-session
PS C:\htb> Get-Module

ModuleType Version    Name                                ExportedCommands
---------- -------    ----                                ----------------
Manifest   3.1.0.0    Microsoft.PowerShell.Utility        {Add-Member, Add-Type, Clear-Variable, Compare-Object...}
Script     2.0.0      PSReadline                          {Get-PSReadLineKeyHandler, Get-PSReadLineOption, Remove-PS...
```

Veremos que el módulo ActiveDirectory aún no se ha importado. Sigamos adelante e importamos.

#### Cargar el módulo de activectory

  Enumeración acreditada: desde Windows

```powershell-session
PS C:\htb> Import-Module ActiveDirectory
PS C:\htb> Get-Module

ModuleType Version    Name                                ExportedCommands
---------- -------    ----                                ----------------
Manifest   1.0.1.0    ActiveDirectory                     {Add-ADCentralAccessPolicyMember, Add-ADComputerServiceAcc...
Manifest   3.1.0.0    Microsoft.PowerShell.Utility        {Add-Member, Add-Type, Clear-Variable, Compare-Object...}
Script     2.0.0      PSReadline                          {Get-PSReadLineKeyHandler, Get-PSReadLineOption, Remove-PS...  
```

Ahora que nuestros módulos están cargados, comencemos. Primero, enumeraremos información básica sobre el dominio con el[Admirador](https://docs.microsoft.com/en-us/powershell/module/activedirectory/get-addomain?view=windowsserver2022-ps)cmdlet.

### Obtener información de dominio

  Enumeración acreditada: desde Windows

```powershell-session
PS C:\htb> Get-ADDomain

AllowedDNSSuffixes                 : {}
ChildDomains                       : {LOGISTICS.INLANEFREIGHT.LOCAL}
ComputersContainer                 : CN=Computers,DC=INLANEFREIGHT,DC=LOCAL
DeletedObjectsContainer            : CN=Deleted Objects,DC=INLANEFREIGHT,DC=LOCAL
DistinguishedName                  : DC=INLANEFREIGHT,DC=LOCAL
DNSRoot                            : INLANEFREIGHT.LOCAL
DomainControllersContainer         : OU=Domain Controllers,DC=INLANEFREIGHT,DC=LOCAL
DomainMode                         : Windows2016Domain
DomainSID                          : S-1-5-21-3842939050-3880317879-2865463114
ForeignSecurityPrincipalsContainer : CN=ForeignSecurityPrincipals,DC=INLANEFREIGHT,DC=LOCAL
Forest                             : INLANEFREIGHT.LOCAL
InfrastructureMaster               : ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL
LastLogonReplicationInterval       :
LinkedGroupPolicyObjects           : {cn={DDBB8574-E94E-4525-8C9D-ABABE31223D0},cn=policies,cn=system,DC=INLANEFREIGHT,
                                     DC=LOCAL, CN={31B2F340-016D-11D2-945F-00C04FB984F9},CN=Policies,CN=System,DC=INLAN
                                     EFREIGHT,DC=LOCAL}
LostAndFoundContainer              : CN=LostAndFound,DC=INLANEFREIGHT,DC=LOCAL
ManagedBy                          :
Name                               : INLANEFREIGHT
NetBIOSName                        : INLANEFREIGHT
ObjectClass                        : domainDNS
ObjectGUID                         : 71e4ecd1-a9f6-4f55-8a0b-e8c398fb547a
ParentDomain                       :
PDCEmulator                        : ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL
PublicKeyRequiredPasswordRolling   : True
QuotasContainer                    : CN=NTDS Quotas,DC=INLANEFREIGHT,DC=LOCAL
ReadOnlyReplicaDirectoryServers    : {}
ReplicaDirectoryServers            : {ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL}
RIDMaster                          : ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL
SubordinateReferences              : {DC=LOGISTICS,DC=INLANEFREIGHT,DC=LOCAL,
                                     DC=ForestDnsZones,DC=INLANEFREIGHT,DC=LOCAL,
                                     DC=DomainDnsZones,DC=INLANEFREIGHT,DC=LOCAL,
                                     CN=Configuration,DC=INLANEFREIGHT,DC=LOCAL}
SystemsContainer                   : CN=System,DC=INLANEFREIGHT,DC=LOCAL
UsersContainer                     : CN=Users,DC=INLANEFREIGHT,DC=LOCAL
```

Esto imprimirá información útil como el dominio SID, el nivel funcional del dominio, cualquier dominio infantil y más. A continuación, usaremos el[Adusente](https://docs.microsoft.com/en-us/powershell/module/activedirectory/get-aduser?view=windowsserver2022-ps)cmdlet. Estaremos filtrando cuentas con el`ServicePrincipalName`propiedad poblada. Esto nos hará una lista de cuentas que pueden ser susceptibles a un ataque de querberoasting, que cubriremos en profundidad después de la siguiente sección.

#### Adusente

  Enumeración acreditada: desde Windows

```powershell-session
PS C:\htb> Get-ADUser -Filter {ServicePrincipalName -ne "$null"} -Properties ServicePrincipalName

DistinguishedName    : CN=adfs,OU=Service Accounts,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL
Enabled              : True
GivenName            : Sharepoint
Name                 : adfs
ObjectClass          : user
ObjectGUID           : 49b53bea-4bc4-4a68-b694-b806d9809e95
SamAccountName       : adfs
ServicePrincipalName : {adfsconnect/azure01.inlanefreight.local}
SID                  : S-1-5-21-3842939050-3880317879-2865463114-5244
Surname              : Admin
UserPrincipalName    :

DistinguishedName    : CN=BACKUPAGENT,OU=Service Accounts,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL
Enabled              : True
GivenName            : Jessica
Name                 : BACKUPAGENT
ObjectClass          : user
ObjectGUID           : 2ec53e98-3a64-4706-be23-1d824ff61bed
SamAccountName       : backupagent
ServicePrincipalName : {backupjob/veam001.inlanefreight.local}
SID                  : S-1-5-21-3842939050-3880317879-2865463114-5220
Surname              : Systemmailbox 8Cc370d3-822A-4Ab8-A926-Bb94bd0641a9
UserPrincipalName    :

<SNIP>
```

Otra comprobación interesante que podemos ejecutar utilizando el módulo activectory, sería verificar las relaciones de confianza de dominio utilizando el[Juguetón](https://docs.microsoft.com/en-us/powershell/module/activedirectory/get-adtrust?view=windowsserver2022-ps)cmdlet

#### Comprobando las relaciones de confianza

  Enumeración acreditada: desde Windows

```powershell-session
PS C:\htb> Get-ADTrust -Filter *

Direction               : BiDirectional
DisallowTransivity      : False
DistinguishedName       : CN=LOGISTICS.INLANEFREIGHT.LOCAL,CN=System,DC=INLANEFREIGHT,DC=LOCAL
ForestTransitive        : False
IntraForest             : True
IsTreeParent            : False
IsTreeRoot              : False
Name                    : LOGISTICS.INLANEFREIGHT.LOCAL
ObjectClass             : trustedDomain
ObjectGUID              : f48a1169-2e58-42c1-ba32-a6ccb10057ec
SelectiveAuthentication : False
SIDFilteringForestAware : False
SIDFilteringQuarantined : False
Source                  : DC=INLANEFREIGHT,DC=LOCAL
Target                  : LOGISTICS.INLANEFREIGHT.LOCAL
TGTDelegation           : False
TrustAttributes         : 32
TrustedPolicy           :
TrustingPolicy          :
TrustType               : Uplevel
UplevelOnly             : False
UsesAESKeys             : False
UsesRC4Encryption       : False

Direction               : BiDirectional
DisallowTransivity      : False
DistinguishedName       : CN=FREIGHTLOGISTICS.LOCAL,CN=System,DC=INLANEFREIGHT,DC=LOCAL
ForestTransitive        : True
IntraForest             : False
IsTreeParent            : False
IsTreeRoot              : False
Name                    : FREIGHTLOGISTICS.LOCAL
ObjectClass             : trustedDomain
ObjectGUID              : 1597717f-89b7-49b8-9cd9-0801d52475ca
SelectiveAuthentication : False
SIDFilteringForestAware : False
SIDFilteringQuarantined : False
Source                  : DC=INLANEFREIGHT,DC=LOCAL
Target                  : FREIGHTLOGISTICS.LOCAL
TGTDelegation           : False
TrustAttributes         : 8
TrustedPolicy           :
TrustingPolicy          :
TrustType               : Uplevel
UplevelOnly             : False
UsesAESKeys             : False
UsesRC4Encryption       : False  
```

Este cmdlet imprimirá cualquier relación de confianza que tenga el dominio. Podemos determinar si son fideicomisos dentro de nuestro bosque o con dominios en otros bosques, el tipo de confianza, la dirección de la confianza y el nombre del dominio con el que está la relación. Esto será útil más adelante cuando busque aprovechar las relaciones de confianza de niños a los niños y atacar entre los fideicomisos forestales. A continuación, podemos recopilar información del grupo de anuncios utilizando el[Acumular](https://docs.microsoft.com/en-us/powershell/module/activedirectory/get-adgroup?view=windowsserver2022-ps)cmdlet.

#### Enumeración grupal

  Enumeración acreditada: desde Windows

```powershell-session
PS C:\htb> Get-ADGroup -Filter * | select name

name
----
Administrators
Users
Guests
Print Operators
Backup Operators
Replicator
Remote Desktop Users
Network Configuration Operators
Performance Monitor Users
Performance Log Users
Distributed COM Users
IIS_IUSRS
Cryptographic Operators
Event Log Readers
Certificate Service DCOM Access
RDS Remote Access Servers
RDS Endpoint Servers
RDS Management Servers
Hyper-V Administrators
Access Control Assistance Operators
Remote Management Users
Storage Replica Administrators
Domain Computers
Domain Controllers
Schema Admins
Enterprise Admins
Cert Publishers
Domain Admins

<SNIP>
```

Podemos tomar los resultados y alimentar nombres interesantes al cmdlet para obtener información más detallada sobre un grupo en particular como así:

#### Información detallada del grupo

  Enumeración acreditada: desde Windows

```powershell-session
PS C:\htb> Get-ADGroup -Identity "Backup Operators"

DistinguishedName : CN=Backup Operators,CN=Builtin,DC=INLANEFREIGHT,DC=LOCAL
GroupCategory     : Security
GroupScope        : DomainLocal
Name              : Backup Operators
ObjectClass       : group
ObjectGUID        : 6276d85d-9c39-4b7c-8449-cad37e8abc38
SamAccountName    : Backup Operators
SID               : S-1-5-32-551
```

Ahora que sabemos más sobre el grupo, obtengamos una lista de miembros usando el[Get-adgroupmember](https://docs.microsoft.com/en-us/powershell/module/activedirectory/get-adgroupmember?view=windowsserver2022-ps)cmdlet.

### Membresía del grupo

  Enumeración acreditada: desde Windows

```powershell-session
PS C:\htb> Get-ADGroupMember -Identity "Backup Operators"

distinguishedName : CN=BACKUPAGENT,OU=Service Accounts,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL
name              : BACKUPAGENT
objectClass       : user
objectGUID        : 2ec53e98-3a64-4706-be23-1d824ff61bed
SamAccountName    : backupagent
SID               : S-1-5-21-3842939050-3880317879-2865463114-5220
```

Podemos ver esa cuenta,`backupagent`, pertenece a este grupo. Vale la pena señalar esto porque si podemos asumir esta cuenta de servicio a través de algún ataque, podríamos usar su membresía en el grupo de operadores de respaldo para hacerse cargo del dominio. Podemos realizar este proceso para que los otros grupos comprendan completamente la configuración de membresía del dominio. Intente repetir el proceso con algunos grupos diferentes. Verá que este proceso puede ser tedioso, y nos quedará una enorme cantidad de datos para examinar. Debemos saber cómo hacer esto con herramientas incorporadas como el módulo activectory PowerShell, pero veremos más adelante en esta sección cuántas herramientas como Bloodhound pueden acelerar este proceso y hacer que nuestros resultados sean mucho más precisos y organizados.

Utilizar el módulo ActiveDirectory en un host puede ser una forma más sigilosa de realizar acciones que dejar una herramienta en un host o cargarlo en la memoria e intentar usarla. De esta manera, nuestras acciones podrían mezclarse más en más. A continuación, caminaremos por la herramienta PowerView, que tiene muchas características para simplificar la enumeración y profundizar en el dominio.

---

## PowerView

[PowerView](https://github.com/PowerShellMafia/PowerSploit/tree/master/Recon)es una herramienta escrita en PowerShell para ayudarnos a obtener conciencia situacional dentro de un entorno publicitario. Al igual que BloodHound, proporciona una forma de identificar dónde los usuarios están iniciados en una red, enumeran la información de dominio, como usuarios, computadoras, grupos, ACL, fideicomisos, buscan acciones y contraseñas de archivos, realizan kerberoasting y más. Es una herramienta muy versátil que puede proporcionarnos una gran visión de la postura de seguridad del dominio de nuestro cliente. Requiere más trabajo manual para determinar las configuraciones erróneas y las relaciones dentro del dominio que el sabueso de sangre, pero, cuando se usa bien, puede ayudarnos a identificar sutiles configuraciones erróneas.

Examinemos algunas de las capacidades de PowerView y veamos qué datos devuelve. La siguiente tabla describe algunas de las funciones más útiles que ofrece PowerView.

|**Dominio**|**Descripción**|
|---|---|
|`Export-PowerViewCSV`|Agregar resultados a un archivo CSV|
|`ConvertTo-SID`|Convertir un nombre de usuario o grupo a su valor SID|
|`Get-DomainSPNTicket`|Solicita el boleto de Kerberos para una cuenta de nombre principal de servicio especificado (SPN)|
|**Funciones de dominio/LDAP:**||
|`Get-Domain`|Devolverá el objeto AD para el dominio actual (o especificado)|
|`Get-DomainController`|Devolver una lista de los controladores de dominio para el dominio especificado|
|`Get-DomainUser`|Devolverá a todos los usuarios o objetos de usuario específicos en AD|
|`Get-DomainComputer`|Devolverá todas las computadoras o objetos de computadora específicos en AD|
|`Get-DomainGroup`|Devolverá todos los grupos o objetos de grupo específicos en AD|
|`Get-DomainOU`|Buscar todos o objetos OU específicos en AD|
|`Find-InterestingDomainAcl`|Encuentra ACL de objetos en el dominio con derechos de modificación establecidos en no construidos en objetos|
|`Get-DomainGroupMember`|Devolverá a los miembros de un grupo de dominio específico|
|`Get-DomainFileServer`|Devuelve una lista de servidores que probablemente funcionen como servidores de archivos|
|`Get-DomainDFSShare`|Devuelve una lista de todos los sistemas de archivos distribuidos para el dominio actual (o especificado)|
|**Funciones GPO:**||
|`Get-DomainGPO`|Devolverá todos los GPO o objetos GPO específicos en AD|
|`Get-DomainPolicy`|Devuelve la política de dominio predeterminada o la política del controlador de dominio para el dominio actual|
|**Funciones de enumeración informática:**||
|`Get-NetLocalGroup`|Enumera grupos locales en la máquina local o remota|
|`Get-NetLocalGroupMember`|Enumera miembros de un grupo local específico|
|`Get-NetShare`|Devuelve acciones abiertas en la máquina local (o una remota)|
|`Get-NetSession`|Devolverá la información de la sesión para la máquina local (o una remota)|
|`Test-AdminAccess`|Prueba si el usuario actual tiene acceso administrativo a la máquina local (o un control remoto)|
|**Funciones 'meta' enhebradas:**||
|`Find-DomainUserLocation`|Encuentra máquinas donde los usuarios específicos están conectados|
|`Find-DomainShare`|Encuentra acciones accesibles en máquinas de dominio|
|`Find-InterestingDomainShareFile`|Búsqueda de archivos que coinciden con criterios específicos en acciones legibles en el dominio|
|`Find-LocalAdminAccess`|Encuentre máquinas en el dominio local donde el usuario actual tiene acceso al administrador local|
|**Funciones de confianza de dominio:**||
|`Get-DomainTrust`|Devuelve los fideicomisos de dominio para el dominio actual o un dominio específico|
|`Get-ForestTrust`|Devuelve todos los fideicomisos forestales para el bosque actual o un bosque específico|
|`Get-DomainForeignUser`|Enumeras a los usuarios que se encuentran en grupos fuera del dominio del usuario|
|`Get-DomainForeignGroupMember`|Enumera grupos con usuarios fuera del dominio del grupo y devuelve cada miembro extranjero|
|`Get-DomainTrustMapping`|Enumerará todos los fideicomisos para el dominio actual y cualquier otro visto.|

Esta tabla no lo abarca todo para lo que ofrece PowerView, pero incluye muchas de las funciones que usaremos repetidamente. Para obtener más información sobre PowerView, consulte el[Módulo PowerView de Active Directory](https://academy.hackthebox.com/course/preview/active-directory-powerview). A continuación experimentaremos con algunos de ellos.

Primero es el[Get Domainuser](https://powersploit.readthedocs.io/en/latest/Recon/Get-DomainUser/)función. Esto nos proporcionará información sobre todos los usuarios o usuarios específicos que especificamos. A continuación la usaremos para obtener información sobre un usuario específico,`mmorgan`.

#### Información del usuario del dominio

  Enumeración acreditada: desde Windows

```powershell-session
PS C:\htb> Get-DomainUser -Identity mmorgan -Domain inlanefreight.local | Select-Object -Property name,samaccountname,description,memberof,whencreated,pwdlastset,lastlogontimestamp,accountexpires,admincount,userprincipalname,serviceprincipalname,useraccountcontrol

name                 : Matthew Morgan
samaccountname       : mmorgan
description          :
memberof             : {CN=VPN Users,OU=Security Groups,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL, CN=Shared Calendar
                       Read,OU=Security Groups,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL, CN=Printer Access,OU=Security
                       Groups,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL, CN=File Share H Drive,OU=Security
                       Groups,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL...}
whencreated          : 10/27/2021 5:37:06 PM
pwdlastset           : 11/18/2021 10:02:57 AM
lastlogontimestamp   : 2/27/2022 6:34:25 PM
accountexpires       : NEVER
admincount           : 1
userprincipalname    : mmorgan@inlanefreight.local
serviceprincipalname :
mail                 :
useraccountcontrol   : NORMAL_ACCOUNT, DONT_EXPIRE_PASSWORD, DONT_REQ_PREAUTH
```

Vimos información básica del usuario con PowerView. Ahora enumeremos alguna información del grupo de dominio. Podemos usar el[Get-domaingroupmember](https://powersploit.readthedocs.io/en/latest/Recon/Get-DomainGroupMember/)función para recuperar información específica del grupo. Agregando el`-Recurse`Switch le dice a PowerView que si encuentra algún grupo que forme parte del grupo objetivo (membresía del grupo anidada) para enumerar a los miembros de esos grupos. Por ejemplo, la siguiente salida muestra que el`Secadmins`El grupo es parte del`Domain Admins`Grupo a través de la membresía del grupo anidada. En este caso, podremos ver a todos los miembros de ese grupo que heredan los derechos de administrador del dominio a través de su membresía grupal.

#### Membresía del grupo recursivo

  Enumeración acreditada: desde Windows

```powershell-session
PS C:\htb>  Get-DomainGroupMember -Identity "Domain Admins" -Recurse

GroupDomain             : INLANEFREIGHT.LOCAL
GroupName               : Domain Admins
GroupDistinguishedName  : CN=Domain Admins,CN=Users,DC=INLANEFREIGHT,DC=LOCAL
MemberDomain            : INLANEFREIGHT.LOCAL
MemberName              : svc_qualys
MemberDistinguishedName : CN=svc_qualys,OU=Service Accounts,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL
MemberObjectClass       : user
MemberSID               : S-1-5-21-3842939050-3880317879-2865463114-5613

GroupDomain             : INLANEFREIGHT.LOCAL
GroupName               : Domain Admins
GroupDistinguishedName  : CN=Domain Admins,CN=Users,DC=INLANEFREIGHT,DC=LOCAL
MemberDomain            : INLANEFREIGHT.LOCAL
MemberName              : sp-admin
MemberDistinguishedName : CN=Sharepoint Admin,OU=Service Accounts,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL
MemberObjectClass       : user
MemberSID               : S-1-5-21-3842939050-3880317879-2865463114-5228

GroupDomain             : INLANEFREIGHT.LOCAL
GroupName               : Secadmins
GroupDistinguishedName  : CN=Secadmins,OU=Security Groups,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL
MemberDomain            : INLANEFREIGHT.LOCAL
MemberName              : spong1990
MemberDistinguishedName : CN=Maggie
                          Jablonski,OU=Operations,OU=Logistics-HK,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL
MemberObjectClass       : user
MemberSID               : S-1-5-21-3842939050-3880317879-2865463114-1965

<SNIP>  
```

Arriba realizamos una mirada recursiva al`Domain Admins`grupo para enumerar a sus miembros. Ahora sabemos a quién apuntar a la posible elevación de privilegios. Al igual que con el módulo AD PowerShell, también podemos enumerar las asignaciones de fideicomiso de dominio.

#### Enumeración de confianza

  Enumeración acreditada: desde Windows

```powershell-session
PS C:\htb> Get-DomainTrustMapping

SourceName      : INLANEFREIGHT.LOCAL
TargetName      : LOGISTICS.INLANEFREIGHT.LOCAL
TrustType       : WINDOWS_ACTIVE_DIRECTORY
TrustAttributes : WITHIN_FOREST
TrustDirection  : Bidirectional
WhenCreated     : 11/1/2021 6:20:22 PM
WhenChanged     : 2/26/2022 11:55:55 PM

SourceName      : INLANEFREIGHT.LOCAL
TargetName      : FREIGHTLOGISTICS.LOCAL
TrustType       : WINDOWS_ACTIVE_DIRECTORY
TrustAttributes : FOREST_TRANSITIVE
TrustDirection  : Bidirectional
WhenCreated     : 11/1/2021 8:07:09 PM
WhenChanged     : 2/27/2022 12:02:39 AM

SourceName      : LOGISTICS.INLANEFREIGHT.LOCAL
TargetName      : INLANEFREIGHT.LOCAL
TrustType       : WINDOWS_ACTIVE_DIRECTORY
TrustAttributes : WITHIN_FOREST
TrustDirection  : Bidirectional
WhenCreated     : 11/1/2021 6:20:22 PM
WhenChanged     : 2/26/2022 11:55:55 PM 
```

Podemos usar el[Administrador de la prueba](https://powersploit.readthedocs.io/en/latest/Recon/Test-AdminAccess/)Funcionar para probar el acceso de administrador local en la máquina actual o en una remota.

#### Prueba de acceso local de administración

  Enumeración acreditada: desde Windows

```powershell-session
PS C:\htb> Test-AdminAccess -ComputerName ACADEMY-EA-MS01

ComputerName    IsAdmin
------------    -------
ACADEMY-EA-MS01    True 
```

Arriba, determinamos que el usuario que estamos utilizando actualmente es un administrador en la Academia Host-EA-MS01. Podemos realizar la misma función para cada host para ver dónde tenemos acceso administrativo. Más tarde veremos qué tan bien BloodHound realiza este tipo de verificación. Ahora podemos verificar a los usuarios con el conjunto de atributos SPN, lo que indica que la cuenta puede estar sometida a un ataque de Kerberoasting.

#### Encontrar usuarios con set SPN

  Enumeración acreditada: desde Windows

```powershell-session
PS C:\htb> Get-DomainUser -SPN -Properties samaccountname,ServicePrincipalName

serviceprincipalname                          samaccountname
--------------------                          --------------
adfsconnect/azure01.inlanefreight.local       adfs
backupjob/veam001.inlanefreight.local         backupagent
d0wngrade/kerberoast.inlanefreight.local      d0wngrade
kadmin/changepw                               krbtgt
MSSQLSvc/DEV-PRE-SQL.inlanefreight.local:1433 sqldev
MSSQLSvc/SPSJDB.inlanefreight.local:1433      sqlprod
MSSQLSvc/SQL-CL01-01inlanefreight.local:49351 sqlqa
sts/inlanefreight.local                       solarwindsmonitor
testspn/kerberoast.inlanefreight.local        testspn
testspn2/kerberoast.inlanefreight.local       testspn2
```

Pruebe algunas más funciones de la herramienta hasta que se sienta cómodo usándola. Veremos PowerView varias veces más a medida que avanzamos a través de este módulo.

---

## Aguja

PowerView es parte del ahora desactivado Kit de herramientas ofensivo de PowersPlopploit PowerShell. La herramienta ha recibido actualizaciones de BC-Security como parte de su[Imperio 4](https://github.com/BC-SECURITY/Empire/blob/master/empire/server/data/module_source/situational_awareness/network/powerview.ps1)estructura. Empire 4 es la bifurcación de BC-Security del Proyecto Empire original y se mantiene activamente a partir de abril de 2022. Mostramos ejemplos a lo largo de este módulo utilizando la versión de desarrollo de PowerView porque es una excelente herramienta para Recon en un entorno de Active Directory, y todavía es extremadamente poderoso y útil en las redes de anuncios modernos, aunque la versión original no se mantiene. La versión BC-Security de[PowerView](https://github.com/BC-SECURITY/Empire/blob/master/empire/server/data/module_source/situational_awareness/network/powerview.ps1)tiene algunas funciones nuevas como`Get-NetGmsa`, solía buscar[Cuentas de servicio administradas grupales](https://docs.microsoft.com/en-us/windows-server/security/group-managed-service-accounts/group-managed-service-accounts-overview), que está fuera de alcance para este módulo. Vale la pena jugar con ambas versiones para ver las diferencias sutiles entre las versiones antiguas y actualmente mantenidas.

Otra herramienta que vale la pena experimentar es Sharpview, un puerto .NET de PowerView. Muchas de las mismas funciones compatibles con PowerView se pueden usar con Sharpview. Podemos escribir un nombre de método con`-Help`Para obtener una lista de argumentos.

  Enumeración acreditada: desde Windows

```powershell-session
PS C:\htb> .\SharpView.exe Get-DomainUser -Help

Get_DomainUser -Identity <String[]> -DistinguishedName <String[]> -SamAccountName <String[]> -Name <String[]> -MemberDistinguishedName <String[]> -MemberName <String[]> -SPN <Boolean> -AdminCount <Boolean> -AllowDelegation <Boolean> -DisallowDelegation <Boolean> -TrustedToAuth <Boolean> -PreauthNotRequired <Boolean> -KerberosPreauthNotRequired <Boolean> -NoPreauth <Boolean> -Domain <String> -LDAPFilter <String> -Filter <String> -Properties <String[]> -SearchBase <String> -ADSPath <String> -Server <String> -DomainController <String> -SearchScope <SearchScope> -ResultPageSize <Int32> -ServerTimeLimit <Nullable`1> -SecurityMasks <Nullable`1> -Tombstone <Boolean> -FindOne <Boolean> -ReturnOne <Boolean> -Credential <NetworkCredential> -Raw <Boolean> -UACFilter <UACEnum> 
```

Aquí podemos usar Sharpview para enumerar información sobre un usuario específico, como el usuario`forend`, que controlamos.

  Enumeración acreditada: desde Windows

```powershell-session
PS C:\htb> .\SharpView.exe Get-DomainUser -Identity forend

[Get-DomainSearcher] search base: LDAP://ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL/DC=INLANEFREIGHT,DC=LOCAL
[Get-DomainUser] filter string: (&(samAccountType=805306368)(|(samAccountName=forend)))
objectsid                      : {S-1-5-21-3842939050-3880317879-2865463114-5614}
samaccounttype                 : USER_OBJECT
objectguid                     : 53264142-082a-4cb8-8714-8158b4974f3b
useraccountcontrol             : NORMAL_ACCOUNT
accountexpires                 : 12/31/1600 4:00:00 PM
lastlogon                      : 4/18/2022 1:01:21 PM
lastlogontimestamp             : 4/9/2022 1:33:21 PM
pwdlastset                     : 2/28/2022 12:03:45 PM
lastlogoff                     : 12/31/1600 4:00:00 PM
badPasswordTime                : 4/5/2022 7:09:07 AM
name                           : forend
distinguishedname              : CN=forend,OU=IT Admins,OU=IT,OU=HQ-NYC,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL
whencreated                    : 2/28/2022 8:03:45 PM
whenchanged                    : 4/9/2022 8:33:21 PM
samaccountname                 : forend
memberof                       : {CN=VPN Users,OU=Security Groups,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL, CN=Shared Calendar Read,OU=Security Groups,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL, CN=Printer Access,OU=Security Groups,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL, CN=File Share H Drive,OU=Security Groups,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL, CN=File Share G Drive,OU=Security Groups,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL}
cn                             : {forend}
objectclass                    : {top, person, organizationalPerson, user}
badpwdcount                    : 0
countrycode                    : 0
usnchanged                     : 3259288
logoncount                     : 26618
primarygroupid                 : 513
objectcategory                 : CN=Person,CN=Schema,CN=Configuration,DC=INLANEFREIGHT,DC=LOCAL
dscorepropagationdata          : {3/24/2022 3:58:07 PM, 3/24/2022 3:57:44 PM, 3/24/2022 3:52:58 PM, 3/24/2022 3:49:31 PM, 7/14/1601 10:36:49 PM}
usncreated                     : 3054181
instancetype                   : 4
codepage                       : 0
```

Experimente con Sharpview en el host MS01 y recree tantos ejemplos de PowerView como sea posible. Aunque la evasión no está en alcance para este módulo, Sharpview puede ser útil cuando un cliente se ha endurecido contra el uso de PowerShell o necesitamos evitar el uso de PowerShell.

---

## Acciones

Las acciones permiten a los usuarios de un dominio acceder rápidamente a la información relevante para sus roles diarios y compartir contenido con su organización. Cuando se configure correctamente, las acciones de Domain requerirán que un usuario esté unido al dominio y se requiere autenticarse al acceder al sistema. También se realizarán permisos para garantizar que los usuarios solo puedan acceder y ver lo que es necesario para su rol diario. Las acciones demasiado permisivas pueden causar una divulgación accidental de información confidencial, especialmente aquellas que contienen médicos, legales, de personal, recursos humanos, datos, etc. En un ataque, obtener control sobre un usuario de dominio estándar que puede acceder a acciones como las acciones de TI/infraestructura podría conducir a la divulgación de datos sensibles como los archivos de configuración o los archivos de autenticación como las claves SSH o las contraseñas que se almacenan en forma insegurada. Queremos identificar cualquier problema como estos para garantizar que el cliente no exponga ningún dato a los usuarios que no necesiten acceder a él para sus trabajos diarios y que cumplan con los requisitos legales/regulatorios a los que estén sujetos (HIPAA, PCI, etc.). Podemos usar PowerView para buscar acciones y luego ayudarnos a cavar a través de ellos o usar varios comandos manuales para buscar cadenas comunes como archivos con`pass`en el nombre. Este puede ser un proceso tedioso, y podemos perder las cosas, especialmente en entornos grandes. Ahora, tomemos un tiempo para explorar la herramienta`Snaffler`Y vea cómo puede ayudarnos a identificar estos problemas de manera más precisa y eficiente.

---

## Snaffer

[Snaffer](https://github.com/SnaffCon/Snaffler)es una herramienta que puede ayudarnos a adquirir credenciales u otros datos confidenciales en un entorno de Active Directory. Snaffler funciona obteniendo una lista de hosts dentro del dominio y luego enumerando a esos hosts para acciones y directorios legibles. Una vez hecho esto, se itera a través de cualquier directorios legible por nuestro usuario y busca archivos que podrían servir para mejorar nuestra posición dentro de la evaluación. Snaffler requiere que se ejecute desde un huésped unido por dominio o en un contexto de usuario de dominio.

Para ejecutar Snaffler, podemos usar el comando a continuación:

#### Ejecución de snaffler

Código:intento

```bash
Snaffler.exe -s -d inlanefreight.local -o snaffler.log -v data
```

El`-s`le dice que imprima los resultados en la consola para nosotros, el`-d`especifica el dominio para buscar dentro y el`-o`le dice a Snaffler que escriba resultados en un archivo de registro. El`-v`La opción es el nivel de verbosidad. Típicamente`data`es mejor ya que solo muestra resultados en la pantalla, por lo que es más fácil comenzar a mirar a través de las ejecuciones de la herramienta. Snaffler puede producir una cantidad considerable de datos, por lo que normalmente debemos salir para archivar y dejar que se ejecute y luego volver a él más tarde. También puede ser útil proporcionar la salida sin procesar Snaffler a los clientes como datos suplementarios durante una prueba de penetración, ya que puede ayudarlos a concentrarse en acciones de alto valor que deben bloquearse primero.

#### Snaffler en acción

  Enumeración acreditada: desde Windows

```powershell-session
PS C:\htb> .\Snaffler.exe  -d INLANEFREIGHT.LOCAL -s -v data

 .::::::.:::.    :::.  :::.    .-:::::'.-:::::':::    .,:::::: :::::::..
;;;`    ``;;;;,  `;;;  ;;`;;   ;;;'''' ;;;'''' ;;;    ;;;;'''' ;;;;``;;;;
'[==/[[[[, [[[[[. '[[ ,[[ '[[, [[[,,== [[[,,== [[[     [[cccc   [[[,/[[['
  '''    $ $$$ 'Y$c$$c$$$cc$$$c`$$$'`` `$$$'`` $$'     $$""   $$$$$$c
 88b    dP 888    Y88 888   888,888     888   o88oo,.__888oo,__ 888b '88bo,
  'YMmMY'  MMM     YM YMM   ''` 'MM,    'MM,  ''''YUMMM''''YUMMMMMMM   'W'
                         by l0ss and Sh3r4 - github.com/SnaffCon/Snaffler

2022-03-31 12:16:54 -07:00 [Share] {Black}(\\ACADEMY-EA-MS01.INLANEFREIGHT.LOCAL\ADMIN$)
2022-03-31 12:16:54 -07:00 [Share] {Black}(\\ACADEMY-EA-MS01.INLANEFREIGHT.LOCAL\C$)
2022-03-31 12:16:54 -07:00 [Share] {Green}(\\ACADEMY-EA-MX01.INLANEFREIGHT.LOCAL\address)
2022-03-31 12:16:54 -07:00 [Share] {Green}(\\ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL\Department Shares)
2022-03-31 12:16:54 -07:00 [Share] {Green}(\\ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL\User Shares)
2022-03-31 12:16:54 -07:00 [Share] {Green}(\\ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL\ZZZ_archive)
2022-03-31 12:17:18 -07:00 [Share] {Green}(\\ACADEMY-EA-CA01.INLANEFREIGHT.LOCAL\CertEnroll)
2022-03-31 12:17:19 -07:00 [File] {Black}<KeepExtExactBlack|R|^\.kdb$|289B|3/31/2022 12:09:22 PM>(\\ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL\Department Shares\IT\Infosec\GroupBackup.kdb) .kdb
2022-03-31 12:17:19 -07:00 [File] {Red}<KeepExtExactRed|R|^\.key$|299B|3/31/2022 12:05:33 PM>(\\ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL\Department Shares\IT\Infosec\ShowReset.key) .key
2022-03-31 12:17:19 -07:00 [Share] {Green}(\\ACADEMY-EA-FILE.INLANEFREIGHT.LOCAL\UpdateServicesPackages)
2022-03-31 12:17:19 -07:00 [File] {Black}<KeepExtExactBlack|R|^\.kwallet$|302B|3/31/2022 12:04:45 PM>(\\ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL\Department Shares\IT\Infosec\WriteUse.kwallet) .kwallet
2022-03-31 12:17:19 -07:00 [File] {Red}<KeepExtExactRed|R|^\.key$|298B|3/31/2022 12:05:10 PM>(\\ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL\Department Shares\IT\Infosec\ProtectStep.key) .key
2022-03-31 12:17:19 -07:00 [File] {Black}<KeepExtExactBlack|R|^\.ppk$|275B|3/31/2022 12:04:40 PM>(\\ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL\Department Shares\IT\Infosec\StopTrace.ppk) .ppk
2022-03-31 12:17:19 -07:00 [File] {Red}<KeepExtExactRed|R|^\.key$|301B|3/31/2022 12:09:17 PM>(\\ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL\Department Shares\IT\Infosec\WaitClear.key) .key
2022-03-31 12:17:19 -07:00 [File] {Red}<KeepExtExactRed|R|^\.sqldump$|312B|3/31/2022 12:05:30 PM>(\\ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL\Department Shares\IT\Development\DenyRedo.sqldump) .sqldump
2022-03-31 12:17:19 -07:00 [File] {Red}<KeepExtExactRed|R|^\.sqldump$|310B|3/31/2022 12:05:02 PM>(\\ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL\Department Shares\IT\Development\AddPublish.sqldump) .sqldump
2022-03-31 12:17:19 -07:00 [Share] {Green}(\\ACADEMY-EA-FILE.INLANEFREIGHT.LOCAL\WsusContent)
2022-03-31 12:17:19 -07:00 [File] {Red}<KeepExtExactRed|R|^\.keychain$|295B|3/31/2022 12:08:42 PM>(\\ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL\Department Shares\IT\Infosec\SetStep.keychain) .keychain
2022-03-31 12:17:19 -07:00 [File] {Black}<KeepExtExactBlack|R|^\.tblk$|279B|3/31/2022 12:05:25 PM>(\\ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL\Department Shares\IT\Development\FindConnect.tblk) .tblk
2022-03-31 12:17:19 -07:00 [File] {Black}<KeepExtExactBlack|R|^\.psafe3$|301B|3/31/2022 12:09:33 PM>(\\ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL\Department Shares\IT\Development\GetUpdate.psafe3) .psafe3
2022-03-31 12:17:19 -07:00 [File] {Red}<KeepExtExactRed|R|^\.keypair$|278B|3/31/2022 12:09:09 PM>(\\ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL\Department Shares\IT\Infosec\UnprotectConvertTo.keypair) .keypair
2022-03-31 12:17:19 -07:00 [File] {Black}<KeepExtExactBlack|R|^\.tblk$|280B|3/31/2022 12:05:17 PM>(\\ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL\Department Shares\IT\Development\ExportJoin.tblk) .tblk
2022-03-31 12:17:19 -07:00 [File] {Red}<KeepExtExactRed|R|^\.mdf$|305B|3/31/2022 12:09:27 PM>(\\ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL\Department Shares\IT\Development\FormatShow.mdf) .mdf
2022-03-31 12:17:19 -07:00 [File] {Red}<KeepExtExactRed|R|^\.mdf$|299B|3/31/2022 12:09:14 PM>(\\ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL\Department Shares\IT\Development\LockConfirm.mdf) .mdf

<SNIP>
```

Podemos encontrar contraseñas, claves SSH, archivos de configuración u otros datos que pueden usarse para promover nuestro acceso. El color Snaffler codifica la salida para nosotros y nos proporciona un resumen de los tipos de archivos que se encuentran en las acciones.

Ahora que tenemos una gran cantidad de datos sobre el dominio LaneFreight. Vamos a sumergirnos más`BloodHound`Y vea cuán poderosa puede ser esta herramienta durante cualquier evaluación de seguridad centrada en AD.

---

### Sabueso

Como se discutió en la sección anterior, `Bloodhound`es una herramienta excepcional de código abierto que puede identificar las rutas de ataque dentro de un entorno AD analizando las relaciones entre objetos. Tanto los probadores de penetración como los equipos azules pueden beneficiarse de aprender a usar Bloodhound para visualizar las relaciones en el dominio. Cuando se usa correctamente y se combina con consultas de cifrado personalizadas, Bloodhound puede encontrar fallas de alto impacto, pero difícil de descubrir, que han estado presentes en el dominio durante años.

Primero, debemos autenticarnos como un usuario de dominio desde un host de ataque de Windows posicionado dentro de la red (pero no unido al dominio) o transferir la herramienta a un host unido por dominio. Hay muchas maneras de lograr esto cubierto en el[Transferencia de archivos](https://academy.hackthebox.com/course/preview/file-transfers)módulo. Para nuestros propósitos, trabajaremos con Sharphound.exe ya en el host de ataque, pero vale la pena experimentar con la transferencia de la herramienta al host de ataque desde Pwnbox o nuestra propia VM utilizando métodos como un servidor Python HTTP, smbserver.py desde impacket, etc.

Si ejecutamos Sharphound con el`--help`Opción, podemos ver las opciones disponibles para nosotros.

#### Sharphound in Action

  Enumeración acreditada: desde Windows

```powershell-session
PS C:\htb>  .\SharpHound.exe --help

SharpHound 1.0.3
Copyright (C) 2022 SpecterOps

  -c, --collectionmethods    (Default: Default) Collection Methods: Container, Group, LocalGroup, GPOLocalGroup,
                             Session, LoggedOn, ObjectProps, ACL, ComputerOnly, Trusts, Default, RDP, DCOM, DCOnly

  -d, --domain               Specify domain to enumerate

  -s, --searchforest         (Default: false) Search all available domains in the forest

  --stealth                  Stealth Collection (Prefer DCOnly whenever possible!)

  -f                         Add an LDAP filter to the pregenerated filter.

  --distinguishedname        Base DistinguishedName to start the LDAP search at

  --computerfile             Path to file containing computer names to enumerate
  
  <SNIP>
```

Comenzaremos ejecutando el coleccionista SharPhound.exe del host de ataque MS01.

  Enumeración acreditada: desde Windows

```powershell-session
PS C:\htb> .\SharpHound.exe -c All --zipfilename ILFREIGHT

2022-04-18T13:58:22.1163680-07:00|INFORMATION|Resolved Collection Methods: Group, LocalAdmin, GPOLocalGroup, Session, LoggedOn, Trusts, ACL, Container, RDP, ObjectProps, DCOM, SPNTargets, PSRemote
2022-04-18T13:58:22.1163680-07:00|INFORMATION|Initializing SharpHound at 1:58 PM on 4/18/2022
2022-04-18T13:58:22.6788709-07:00|INFORMATION|Flags: Group, LocalAdmin, GPOLocalGroup, Session, LoggedOn, Trusts, ACL, Container, RDP, ObjectProps, DCOM, SPNTargets, PSRemote
2022-04-18T13:58:23.0851206-07:00|INFORMATION|Beginning LDAP search for INLANEFREIGHT.LOCAL
2022-04-18T13:58:53.9132950-07:00|INFORMATION|Status: 0 objects finished (+0 0)/s -- Using 67 MB RAM
2022-04-18T13:59:15.7882419-07:00|INFORMATION|Producer has finished, closing LDAP channel
2022-04-18T13:59:16.1788930-07:00|INFORMATION|LDAP channel closed, waiting for consumers
2022-04-18T13:59:23.9288698-07:00|INFORMATION|Status: 3793 objects finished (+3793 63.21667)/s -- Using 112 MB RAM
2022-04-18T13:59:45.4132561-07:00|INFORMATION|Consumers finished, closing output channel
Closing writers
2022-04-18T13:59:45.4601086-07:00|INFORMATION|Output channel closed, waiting for output task to complete
2022-04-18T13:59:45.8663528-07:00|INFORMATION|Status: 3809 objects finished (+16 46.45122)/s -- Using 110 MB RAM
2022-04-18T13:59:45.8663528-07:00|INFORMATION|Enumeration finished in 00:01:22.7919186
2022-04-18T13:59:46.3663660-07:00|INFORMATION|SharpHound Enumeration Completed at 1:59 PM on 4/18/2022! Happy Graphing
```

A continuación, podemos exfiltrar el conjunto de datos a nuestra propia VM o ingerirlo en la herramienta GUI de Bloodhound en MS01. Podemos hacer esto en MS01 escribiendo`bloodhound`en una consola CMD o PowerShell. Las credenciales deben salvarse, pero ingrese`neo4j: HTB_@cademy_stdnt!`Si aparece un mensaje. A continuación, haga clic en el`Upload Data`botón En el lado derecho, seleccione el archivo zip recién generado y haga clic en`Open`. Un`Upload Progress`La ventana aparecerá. Una vez que todos los archivos .json muestran 100% completos, haga clic en X en la parte superior de esa ventana.

Podemos comenzar escribiendo`domain:`en la barra de búsqueda en la parte superior izquierda y eligiendo`INLANEFREIGHT.LOCAL`de los resultados. Tómese un momento para navegar por la pestaña Información del nodo. Como podemos ver, esta sería una empresa bastante grande con más de 550 hosts para atacar y fideos con otros dos dominios.

Ahora, vamos a ver algunas consultas preconstruidas en el`Analysis`pestaña. La consulta`Find Computers with Unsupported Operating Systems`es ideal para encontrar sistemas operativos obsoletos y no respaldados que ejecutan un software heredado. Estos sistemas son relativamente comunes para encontrar dentro de las redes empresariales (especialmente entornos más antiguos), ya que a menudo ejecutan algún producto que aún no se puede actualizar o reemplazar. Mantener a estos hosts puede ahorrar dinero, pero también pueden agregar vulnerabilidades innecesarias a la red. Los hosts más antiguos pueden ser susceptibles a las vulnerabilidades de ejecución de código remoto más antiguos como[MS08-067](https://support.microsoft.com/en-us/topic/ms08-067-vulnerability-in-server-service-could-allow-remote-code-execution-ac7878fc-be69-7143-472d-2507a179cd15). Si nos encontramos con estos anfitriones más antiguos durante una evaluación, debemos tener cuidado antes de atacarlos (o incluso consultar con nuestro cliente), ya que pueden ser frágiles y ejecutar una aplicación o servicio crítico. Podemos aconsejar a nuestro cliente que segmine estos hosts del resto de la red tanto como sea posible si aún no pueden eliminarlos, pero también deberían recomendar que comiencen a armar un plan para desmantelarlos y reemplazarlos.

Esta consulta muestra dos hosts, uno que ejecuta Windows 7 y otro con Windows Server 2008 (los cuales no están "en vivo" en nuestro laboratorio). A veces veremos anfitriones que ya no se encienden pero que aún aparecen como registros en AD. Siempre debemos validar si están "en vivo" o no antes de hacer recomendaciones en nuestros informes. Podemos escribir un hallazgo de alto riesgo para los sistemas operativos heredados o una recomendación de las mejores prácticas para limpiar los registros antiguos en AD.

#### Sistemas operativos no compatibles

![text](https://academy.hackthebox.com/storage/modules/143/unsupported.png)

A menudo veremos usuarios con derechos de administrador locales en su host (tal vez temporalmente para instalar un software, y los derechos nunca fueron eliminados), o ocupan un papel lo suficientemente alto en la organización para exigir estos derechos (ya sea que los requiera o no). Otras veces veremos derechos de administrador locales excesivos entregados en toda la organización, como múltiples grupos en el departamento de TI con administrador local sobre grupos de servidores o incluso todo el grupo de usuarios de dominio con administrador local sobre uno o más hosts. Esto puede beneficiarnos si asumimos una cuenta de usuario con estos derechos sobre una o más máquinas. Podemos ejecutar la consulta`Find Computers where Domain Users are Local Admin`Para ver rápidamente si hay hosts donde todos los usuarios tienen derechos de administración locales. Si este es el caso, entonces cualquier cuenta que controlamos generalmente puede usarse para acceder a los hosts en cuestión, y podemos recuperar credenciales de la memoria o encontrar otros datos confidenciales.

#### Administradores locales

![text](https://academy.hackthebox.com/storage/modules/143/local-admin.png)

Esta es solo una instantánea de las consultas útiles que podemos ejecutar. A medida que continuamos a través de este módulo, verá varios más que pueden ser útiles para encontrar otras debilidades en el dominio. Para un estudio más profundo sobre Bloodhound, consulte el módulo[Bloodal de Directorio Active](https://academy.hackthebox.com/course/preview/active-directory-bloodhound). Tómese un tiempo y pruebe cada una de las consultas en el`Analysis`Pestaña para familiarizarse más con la herramienta. También vale la pena experimentar con[Consultas de Cypher personalizadas](https://hausec.com/2019/09/09/bloodhound-cypher-cheatsheet/)al pegarlos en el`Raw Query`Cuadro en la parte inferior de la pantalla.

Tenga en cuenta que a medida que avanzamos por el compromiso, deberíamos documentar cada archivo que se transfiera hacia y desde los hosts en el dominio y donde se colocaron en el disco. Esta es una buena práctica si tenemos que desconfiar nuestras acciones con el cliente. Además, dependiendo del alcance del compromiso, desea asegurarse de cubrir sus pistas y limpiar cualquier cosa que ponga en el medio ambiente al final del compromiso.

---

Tenemos una gran imagen del diseño, fortalezas y debilidades del dominio. Tenemos credenciales para varios usuarios y hemos enumerado una gran cantidad de información, como usuarios, grupos, computadoras, GPO, ACL, derechos de administrador locales, derechos de acceso (RDP, WinRM, etc.), cuentas configuradas con nombres principales de servicio (SPN) y más. Tenemos notas detalladas y una gran cantidad de producción y experimentamos con muchas herramientas diferentes para practicar AD enumerando con y sin credenciales de los hosts de ataques de Linux y Windows. ¿Qué sucede si estamos restringidos con el shell que tenemos o no la capacidad de importar herramientas? Nuestro cliente puede pedirnos que realicemos todo el trabajo desde un host administrado dentro de su red sin acceso a Internet y no hay forma de cargar nuestras herramientas. Podríamos aterrizar en un anfitrión como`SYSTEM`Después de un ataque exitoso, pero estar en una posición en la que sea muy difícil o no es posible cargar herramientas. ¿Qué hacemos entonces? En la siguiente sección, veremos cómo realizar acciones mientras "vive fuera de la tierra".